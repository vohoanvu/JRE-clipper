<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>What would Joe Rogan say? - JRE Clipper</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <script src="https://cloud.google.com/ai/gen-app-builder/client?hl=en_US"></script>

  <!-- Firebase App is required and must be listed first -->
  <script defer src="/__/firebase/11.9.1/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/11.9.1/firebase-functions-compat.js"></script>

  <script defer src="/__/firebase/init.js"></script>

  <style media="screen">
    body {
      font-family: "Pico", sans-serif;
    }

    main.container {
      padding: 2rem;
      max-width: 1500px;
      margin: 0 auto;
      width: 95%;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .videos-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }

    @media (max-width: 768px) {
      .videos-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    .video-container {
      margin: 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
      height: fit-content;
    }

    .video-embed {
      width: 100%;
      height: 280px;
      border: none;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .video-embed {
        height: 240px;
      }
    }

    .segments-list {
      margin-top: 1rem;
    }

    .segment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .segment-item:hover {
      background: #f0f0f0;
    }

    .segment-content {
      flex: 1;
      margin-right: 1rem;
    }

    .segment-timestamp-text {
      font-size: 1rem;
      color: #333;
      font-weight: 600;
      line-height: 1.4;
    }

    .skip-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      text-transform: uppercase;
      max-width: fit-content;
    }

    .skip-btn:hover {
      background: #0056b3;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .video-title {
      color: #0066cc;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
    }

    .segments-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .answer-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .answer-header {
      font-size: 1.2rem;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .answer-content {
      font-size: 1rem;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
    }

    .answer-loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #666;
      font-style: italic;
    }

    .gemini-loading {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 0.5rem;
    }

    .gemini-loading .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: gemini-pulse 1.4s ease-in-out infinite;
    }

    .gemini-loading .dot:nth-child(1) {
      background: #4285F4; /* Google Blue */
      animation-delay: 0s;
    }

    .gemini-loading .dot:nth-child(2) {
      background: #EA4335; /* Google Red */
      animation-delay: 0.2s;
    }

    .gemini-loading .dot:nth-child(3) {
      background: #FBBC04; /* Google Yellow */
      animation-delay: 0.4s;
    }

    .gemini-loading .dot:nth-child(4) {
      background: #34A853; /* Google Green */
      animation-delay: 0.6s;
    }

    @keyframes gemini-pulse {
      0%, 60%, 100% {
        transform: scale(1);
        opacity: 0.7;
      }
      30% {
        transform: scale(1.4);
        opacity: 1;
      }
    }

    .answer-loading .dots::after {
      content: '';
      animation: dots 1.5s ease-in-out infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    .answer-error {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 1rem;
      border-radius: 4px;
    }

    .citations {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #dee2e6;
      font-size: 0.9rem;
      color: #666;
    }

    .citation {
      margin: 0.25rem 0;
    }
  </style>
</head>

<body>
  <main class="container">
    <h1>What would Joe Rogan say about...?</h1>
    <p>Enter a topic to find relevant segments from Joe Rogan Experience episodes with embedded video players and clickable timestamps.</p>

    <!-- The search input field and buttons -->
    <div style="display: flex; gap: 1rem;">
      <input type="search" placeholder="Authenticating, please wait..." id="searchInput" style="margin: 0;" disabled />
      <button id="searchButton" style="margin: 0;" disabled>Search</button>
    </div>
    
    <!-- Container for AI-generated answer -->
    <div id="answer-section" style="margin-top: 2rem;"></div>

    <!-- Container for search results -->
    <div id="search-results" style="margin-top: 2rem;"></div>

    <!-- Container for video players -->
    <div id="video-players-container" style="margin-top: 2rem;"></div>

  </main>
  
  <script>
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResultsContainer = document.getElementById('search-results');
    const answerSection = document.getElementById('answer-section');
    const videoPlayersContainer = document.getElementById('video-players-container');

    const tokenFunctionUrl = 'https://us-central1-gen-lang-client-demo.cloudfunctions.net/getVertexAiToken';
    const searchApiUrl = 'https://us-discoveryengine.googleapis.com/v1alpha/projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/servingConfigs/default_search:search';
    const answerApiUrl = 'https://us-discoveryengine.googleapis.com/v1alpha/projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/servingConfigs/default_search:answer';

    let accessToken = null;
    let lastSearchResults = [];
    let currentSession = null;
    let currentQueryId = null;
    let players = {}; // Store YouTube player instances

    // --- 1. AUTHENTICATION ---
    fetch(tokenFunctionUrl)
      .then(response => {
        if (!response.ok) { 
          return response.json().then(err => { 
            throw new Error(`Auth Error: ${err.error || 'Unknown'}`); 
          }); 
        }
        return response.json();
      })
      .then(data => {
        if (data.accessToken) {
          accessToken = data.accessToken;
          searchInput.disabled = false;
          searchButton.disabled = false;
          searchInput.placeholder = "e.g. Jiu Jitsu, Bears, Bees, Aliens, Psychedelic Drugs";
        } else {
          searchInput.placeholder = "Authentication error. See console.";
          console.error("Could not fetch access token from backend.", data.error || '');
        }
      })
      .catch(error => {
        searchInput.placeholder = "Could not authenticate. See console.";
        console.error("Error fetching access token:", error);
      });

    // --- 2. SEARCH EVENT HANDLING ---
    searchButton.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query) performSearch(query);
    });

    searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const query = searchInput.value.trim();
        if (query) performSearch(query);
      }
    });

    // --- 3. PERFORM SEARCH ---
    function performSearch(query) {
      if (!accessToken) { 
        console.error("Cannot search: Not authenticated."); 
        return; 
      }

      searchInput.placeholder = "Searching...";
      searchButton.setAttribute('aria-busy', 'true');
      searchResultsContainer.innerHTML = '';
      answerSection.innerHTML = '';
      videoPlayersContainer.innerHTML = '';

      fetch(searchApiUrl, {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${accessToken}`, 
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify({ 
          query: query, 
          pageSize: 20, 
          queryExpansionSpec: { condition: "AUTO" }, 
          spellCorrectionSpec: { mode: "AUTO" }, 
          languageCode: "en-US",
          userInfo: { timeZone: "Asia/Saigon" },
          session: "projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/sessions/-"
        })
      })
        .then(response => {
          if (!response.ok) { 
            return response.json().then(err => { 
              throw new Error(`API Error: ${err.error.message}`); 
            }); 
          }
          return response.json();
        })
        .then(data => {
          lastSearchResults = data.results || [];
          
          // Extract session and queryId from the API response
          currentSession = data.sessionInfo?.name || null;
          currentQueryId = data.sessionInfo?.queryId || null;
          
          console.log('Search completed:', data);
          
          if (lastSearchResults.length > 0) {
            // Generate AI answer first
            generateAnswer(query);
            // Then display search summary
            displaySearchSummary(lastSearchResults);
            // Finally load video players
            loadVideoPlayers(lastSearchResults);
          } else {
            displaySearchSummary(lastSearchResults);
          }
        })
        .catch(error => {
          console.error('Search failed:', error);
          searchResultsContainer.innerHTML = `<p style="color: red;">Search failed: ${error.message}</p>`;
        })
        .finally(() => {
          searchInput.placeholder = "e.g. Jiu Jitsu, Bears, Bees, Aliens";
          searchButton.removeAttribute('aria-busy');
        });
    }

    // --- 4. DISPLAY SEARCH SUMMARY ---
    function displaySearchSummary(results) {
      if (results.length === 0) {
        searchResultsContainer.innerHTML = '<p>No results found.</p>';
        return;
      }

      // Group results by video
      const videoGroups = {};
      results.forEach(item => {
        const videoId = item.document.structData.structData.videoId;
        const videoTitle = item.document.structData.structData.videoTitle;
        
        if (!videoGroups[videoId]) {
          videoGroups[videoId] = {
            title: videoTitle,
            segments: []
          };
        }
        
        videoGroups[videoId].segments.push(item);
      });

      const uniqueVideos = Object.keys(videoGroups);
      
      let html = `<h3>Found ${results.length} relevant segments from ${uniqueVideos.length} JRE episodes</h3>`;
      
      // Show video breakdown
      html += '<div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin: 1rem 0;">';
      Object.entries(videoGroups).forEach(([videoId, data]) => {
        html += `<div style="margin-bottom: 0.5rem;">
          <strong>${data.title}</strong> - ${data.segments.length} segment${data.segments.length > 1 ? 's' : ''}
        </div>`;
      });
      html += '</div>';
      
      html += '<p style="color: #666; font-style: italic;">Watch the episode segments below...</p>';
      
      searchResultsContainer.innerHTML = html;
    }

    // --- 4.5. GENERATE AI ANSWER ---
    function generateAnswer(originalQuery) {
      if (!currentSession || !currentQueryId) {
        console.error('Cannot generate answer: Missing session or queryId');
        return;
      }

      answerSection.innerHTML = `
        <div class="answer-section">
          <div class="answer-header">
            🎙️ What Joe Rogan Would Say...
          </div>
          <div class="answer-loading">
            <div class="gemini-loading">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span>AI Joe Rogan is thinking<span class="dots"></span></span>
          </div>
        </div>
      `;

      const answerPayload = {
        query: {
          text: originalQuery,
          queryId: currentQueryId
        },
        session: currentSession,
        answerGenerationSpec: {
          ignoreAdversarialQuery: false,
          ignoreNonAnswerSeekingQuery: false,
          ignoreLowRelevantContent: false,
          multimodalSpec: {},
          includeCitations: true,
          promptSpec: {
            preamble: "You are an expert at the Joe Rogan Experience podcast and its content. You are very knowledgeable about JRE content and more importantly all of the guests that have appeared on the JRE show.\n\nUse Joe Rogan style of communication.\nUse the tone of professional comedians that are close to the Comedy circle of Joe Rogan.\n\nOccasionally at the end of every answer, make a joke about encouraging the users to take more psychedelic drugs and practice Martial Arts to learn more about the given topic. Use some funny emojis"
          },
          modelSpec: {
            modelVersion: "stable"
          }
        }
      };

      console.log('Generating answer with payload:', answerPayload);

      fetch(answerApiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(answerPayload)
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(`Answer API Error: ${err.error?.message || 'Unknown error'}`);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('Answer response:', data);
          displayAnswer(data);
        })
        .catch(error => {
          console.error('Answer generation failed:', error);
          answerSection.innerHTML = `
            <div class="answer-section">
              <div class="answer-header">
                🎙️ What Joe Rogan Would Say...
              </div>
              <div class="answer-error">
                Failed to generate answer: ${error.message}
              </div>
            </div>
          `;
        });
    }

    // --- 4.6. DISPLAY AI ANSWER ---
    function displayAnswer(answerData) {
      if (!answerData?.answer) {
        answerSection.innerHTML = `
          <div class="answer-section">
            <div class="answer-header">
              🎙️ What Joe Rogan Would Say...
            </div>
            <div class="answer-error">
              No answer generated. Try a different search query.
            </div>
          </div>
        `;
        return;
      }

      const answer = answerData.answer;
      let answerText = answer.answerText || 'No answer text available.';

      answerSection.innerHTML = `
        <div class="answer-section">
          <div class="answer-header">
            🎙️ What Joe Rogan Would Say About "${lastSearchResults.length > 0 ? searchInput.value : 'this topic'}"
          </div>
          <div class="answer-content">${answerText}</div>
        </div>
      `;
    }

    // --- 5. LOAD VIDEO PLAYERS ---
    function loadVideoPlayers(results) {
      videoPlayersContainer.innerHTML = '<div class="loading">Loading video players...</div>';

      // Prepare segments data for the backend
      const segmentData = results.map(item => {
        const data = item.document.structData.structData;
        // Extract start and end times from id (format: "videoId_startTime_endTime")
        const idParts = data.id ? data.id.split('_') : [];
        let startTime = idParts.length >= 2 ? parseInt(idParts[1]) : data.startTime;
        let endTime = idParts.length >= 3 ? parseInt(idParts[2]) : data.endTime;
        
        return {
          videoId: data.videoId,
          startTimeSeconds: startTime,
          endTimeSeconds: endTime,
          videoTitle: data.videoTitle,
          segmentText: item.document.structData.content
        };
      });

      // Wait for Firebase to be ready
      if (typeof firebase === 'undefined') {
        console.error("Firebase is not loaded");
        videoPlayersContainer.innerHTML = '<p style="color: red;">Firebase is not ready. Please refresh the page.</p>';
        return;
      }

      try {
        const getVideoMetadata = firebase.functions().httpsCallable('getVideoMetadata');
        
        getVideoMetadata({ segments: segmentData })
          .then((result) => {
            console.log("Got video metadata:", result.data);
            
            // Validate response structure
            if (!result.data || !result.data.success) {
              throw new Error(result.data?.error || 'Invalid response from video metadata service');
            }
            
            renderVideoPlayers(result.data);
          })
          .catch((error) => {
            console.error("Error fetching video metadata:", error);
            
            // Provide more specific error messages
            let errorMessage = 'Failed to load video players';
            if (error.code === 'permission-denied') {
              errorMessage = 'YouTube API access denied. Please check API key configuration.';
            } else if (error.code === 'resource-exhausted') {
              errorMessage = 'YouTube API quota exceeded. Please try again later.';
            } else if (error.message) {
              errorMessage += ': ' + error.message;
            }
            
            videoPlayersContainer.innerHTML = `<p style="color: red;">${errorMessage}</p>`;
          });
      } catch (error) {
        console.error("Error setting up metadata call:", error);
        videoPlayersContainer.innerHTML = `<p style="color: red;">Failed to initialize video players: ${error.message}</p>`;
      }
    }

    // --- 6. RENDER VIDEO PLAYERS ---
    function renderVideoPlayers(videoData) {
      // Fix: Handle the correct data structure from Firebase function
      if (!videoData || !videoData.success || !videoData.videoGroups) {
        videoPlayersContainer.innerHTML = '<p>No video data available.</p>';
        return;
      }

      const videoGroups = videoData.videoGroups;
      const videoIds = Object.keys(videoGroups);
      
      if (videoIds.length === 0) {
        videoPlayersContainer.innerHTML = '<p>No videos found.</p>';
        return;
      }

      let playersHtml = '<div class="videos-grid">';
      
      // Convert videoGroups object to array format for rendering
      videoIds.forEach((videoId, index) => {
        const videoGroup = videoGroups[videoId];
        const videoMetadata = videoGroup.metadata;
        const segments = videoGroup.segments;
        
        // Skip if no metadata available
        if (!videoMetadata) {
          console.warn(`No metadata available for video ${videoId}`);
          return;
        }
        
        const embedId = `player-${videoId}`;
        
        playersHtml += `
          <div class="video-container">
            <div class="video-title">${videoMetadata.title || 'JRE Episode'}</div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
              ${videoMetadata.channelTitle} • ${videoMetadata.viewCount ? parseInt(videoMetadata.viewCount).toLocaleString() + ' views' : ''} • ${videoMetadata.publishedAt ? new Date(videoMetadata.publishedAt).toLocaleDateString() : ''}
            </div>
            <iframe 
              id="${embedId}"
              class="video-embed"
              src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0"
              allowfullscreen>
            </iframe>
            <div class="segments-list">
              <div class="segments-header">Relevant Segments (${segments.length}):</div>
              ${segments.map((segment, segIndex) => `
                <div class="segment-item">
                  <div class="segment-content">
                    <div class="segment-timestamp-text">The search topic was mentioned at: ${formatTimeHMS(segment.startTimeSeconds)}</div>
                  </div>
                  <button class="skip-btn" onclick="seekToTime('${videoId}', ${segment.startTimeSeconds})">
                    SKIP TO
                  </button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      playersHtml += '</div>';
      videoPlayersContainer.innerHTML = playersHtml;

      // Note: Removed auto-seek functionality to prevent autoplay on page load
    }

    // --- 7. UTILITY FUNCTIONS ---
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function formatTimeHMS(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;
      
      if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      } else {
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
      }
    }

    function seekToTime(videoId, startTime) {
      console.log(`Seeking to time ${startTime} for video ${videoId}`);
      
      const iframe = document.getElementById(`player-${videoId}`);
      if (!iframe) {
        console.error(`Could not find iframe with id: player-${videoId}`);
        return;
      }
      
      // Create a new URL with the timestamp
      const baseUrl = `https://www.youtube.com/embed/${videoId}`;
      const params = new URLSearchParams({
        enablejsapi: '1',
        rel: '0',
        start: startTime,
        autoplay: '1'
      });
      const newSrc = `${baseUrl}?${params.toString()}`;
      
      console.log(`Updating iframe src to: ${newSrc}`);
      
      // Update the iframe source
      iframe.src = newSrc;
      
      // Scroll to the video player smoothly
      iframe.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // Optional: Add visual feedback
      const button = event?.target;
      if (button) {
        button.textContent = 'LOADING...';
        button.disabled = true;
        
        setTimeout(() => {
          button.textContent = 'SKIP TO';
          button.disabled = false;
        }, 2000);
      }
    }

  </script>
</body>

</html>