<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>What would Joe Rogan say? - JRE Clipper</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <script src="https://cloud.google.com/ai/gen-app-builder/client?hl=en_US"></script>

  <!-- Firebase App is required and must be listed first -->
  <script defer src="/__/firebase/11.9.1/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/11.9.1/firebase-functions-compat.js"></script>

  <script defer src="/__/firebase/init.js"></script>

  <style media="screen">
    body {
      font-family: "Pico", sans-serif;
    }

    main {
      padding: 2rem;
    }

    .video-container {
      margin: 2rem 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .video-embed {
      width: 100%;
      height: 315px;
      border: none;
      border-radius: 4px;
    }

    .segments-list {
      margin-top: 1rem;
    }

    .segment-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 0.5rem;
      margin: 0.5rem 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .segment-item:hover {
      background: #f0f0f0;
    }

    .segment-content {
      flex: 1;
      margin-right: 1rem;
    }

    .segment-text {
      font-size: 0.9rem;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .segment-timestamp {
      font-size: 0.8rem;
      color: #666;
      font-weight: bold;
    }

    .timestamp-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      min-width: 60px;
    }

    .timestamp-btn:hover {
      background: #0056b3;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .video-title {
      color: #0066cc;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
    }

    .segments-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }
  </style>
</head>

<body>
  <main class="container">
    <h1>What would Joe Rogan say about...?</h1>
    <p>Enter a topic to find relevant segments from Joe Rogan Experience episodes with embedded video players and clickable timestamps.</p>

    <!-- The search input field and buttons -->
    <div style="display: flex; gap: 1rem;">
      <input type="search" placeholder="Authenticating, please wait..." id="searchInput" style="margin: 0;" disabled />
      <button id="searchButton" style="margin: 0;" disabled>Search</button>
    </div>

    <!-- Container for search results -->
    <div id="search-results" style="margin-top: 2rem;"></div>

    <!-- Container for video players -->
    <div id="video-players-container" style="margin-top: 2rem;"></div>

  </main>
  
  <script>
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResultsContainer = document.getElementById('search-results');
    const videoPlayersContainer = document.getElementById('video-players-container');

    const tokenFunctionUrl = 'https://us-central1-gen-lang-client-demo.cloudfunctions.net/getVertexAiToken';
    const searchApiUrl = 'https://us-discoveryengine.googleapis.com/v1alpha/projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/servingConfigs/default_search:search';

    let accessToken = null;
    let lastSearchResults = [];
    let players = {}; // Store YouTube player instances

    // --- 1. AUTHENTICATION ---
    fetch(tokenFunctionUrl)
      .then(response => {
        if (!response.ok) { 
          return response.json().then(err => { 
            throw new Error(`Auth Error: ${err.error || 'Unknown'}`); 
          }); 
        }
        return response.json();
      })
      .then(data => {
        if (data.accessToken) {
          accessToken = data.accessToken;
          searchInput.disabled = false;
          searchButton.disabled = false;
          searchInput.placeholder = "e.g. Jiu Jitsu, Bears, Bees, Aliens";
        } else {
          searchInput.placeholder = "Authentication error. See console.";
          console.error("Could not fetch access token from backend.", data.error || '');
        }
      })
      .catch(error => {
        searchInput.placeholder = "Could not authenticate. See console.";
        console.error("Error fetching access token:", error);
      });

    // --- 2. SEARCH EVENT HANDLING ---
    searchButton.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query) performSearch(query);
    });

    searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const query = searchInput.value.trim();
        if (query) performSearch(query);
      }
    });

    // --- 3. PERFORM SEARCH ---
    function performSearch(query) {
      if (!accessToken) { 
        console.error("Cannot search: Not authenticated."); 
        return; 
      }

      searchInput.placeholder = "Searching...";
      searchButton.setAttribute('aria-busy', 'true');
      searchResultsContainer.innerHTML = '';
      videoPlayersContainer.innerHTML = '';

      fetch(searchApiUrl, {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${accessToken}`, 
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify({ 
          query: query, 
          pageSize: 20, 
          queryExpansionSpec: { condition: "AUTO" }, 
          spellCorrectionSpec: { mode: "AUTO" }, 
          languageCode: "en-US" 
        })
      })
        .then(response => {
          if (!response.ok) { 
            return response.json().then(err => { 
              throw new Error(`API Error: ${err.error.message}`); 
            }); 
          }
          return response.json();
        })
        .then(data => {
          lastSearchResults = data.results || [];
          displaySearchSummary(lastSearchResults);
          if (lastSearchResults.length > 0) {
            loadVideoPlayers(lastSearchResults);
          }
        })
        .catch(error => {
          console.error('Search failed:', error);
          searchResultsContainer.innerHTML = `<p style="color: red;">Search failed: ${error.message}</p>`;
        })
        .finally(() => {
          searchInput.placeholder = "e.g. Jiu Jitsu, Bears, Bees, Aliens";
          searchButton.removeAttribute('aria-busy');
        });
    }

    // --- 4. DISPLAY SEARCH SUMMARY ---
    function displaySearchSummary(results) {
      if (results.length === 0) {
        searchResultsContainer.innerHTML = '<p>No results found.</p>';
        return;
      }

      // Group results by video
      const videoGroups = {};
      results.forEach(item => {
        const videoId = item.document.structData.structData.videoId;
        const videoTitle = item.document.structData.structData.videoTitle;
        
        if (!videoGroups[videoId]) {
          videoGroups[videoId] = {
            title: videoTitle,
            segments: []
          };
        }
        
        videoGroups[videoId].segments.push(item);
      });

      const uniqueVideos = Object.keys(videoGroups);
      
      let html = `<h3>Found ${results.length} relevant segments from ${uniqueVideos.length} JRE episodes</h3>`;
      
      // Show video breakdown
      html += '<div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin: 1rem 0;">';
      Object.entries(videoGroups).forEach(([videoId, data]) => {
        html += `<div style="margin-bottom: 0.5rem;">
          <strong>${data.title}</strong> - ${data.segments.length} segment${data.segments.length > 1 ? 's' : ''}
        </div>`;
      });
      html += '</div>';
      
      html += '<p style="color: #666; font-style: italic;">Watch the eposide segments below...</p>';
      
      searchResultsContainer.innerHTML = html;
    }

    // --- 5. LOAD VIDEO PLAYERS ---
    function loadVideoPlayers(results) {
      videoPlayersContainer.innerHTML = '<div class="loading">Loading video players...</div>';

      // Prepare segments data for the backend
      const segmentData = results.map(item => {
        const data = item.document.structData.structData;
        // Extract start and end times from id (format: "videoId_startTime_endTime")
        const idParts = data.id ? data.id.split('_') : [];
        let startTime = idParts.length >= 2 ? parseInt(idParts[1]) : data.startTime;
        let endTime = idParts.length >= 3 ? parseInt(idParts[2]) : data.endTime;
        
        return {
          videoId: data.videoId,
          startTimeSeconds: startTime,
          endTimeSeconds: endTime,
          videoTitle: data.videoTitle,
          segmentText: item.document.structData.content
        };
      });

      // Wait for Firebase to be ready
      if (typeof firebase === 'undefined') {
        console.error("Firebase is not loaded");
        videoPlayersContainer.innerHTML = '<p style="color: red;">Firebase is not ready. Please refresh the page.</p>';
        return;
      }

      try {
        const getVideoMetadata = firebase.functions().httpsCallable('getVideoMetadata');
        
        getVideoMetadata({ segments: segmentData })
          .then((result) => {
            console.log("Got video metadata:", result.data);
            
            // Validate response structure
            if (!result.data || !result.data.success) {
              throw new Error(result.data?.error || 'Invalid response from video metadata service');
            }
            
            renderVideoPlayers(result.data);
          })
          .catch((error) => {
            console.error("Error fetching video metadata:", error);
            
            // Provide more specific error messages
            let errorMessage = 'Failed to load video players';
            if (error.code === 'permission-denied') {
              errorMessage = 'YouTube API access denied. Please check API key configuration.';
            } else if (error.code === 'resource-exhausted') {
              errorMessage = 'YouTube API quota exceeded. Please try again later.';
            } else if (error.message) {
              errorMessage += ': ' + error.message;
            }
            
            videoPlayersContainer.innerHTML = `<p style="color: red;">${errorMessage}</p>`;
          });
      } catch (error) {
        console.error("Error setting up metadata call:", error);
        videoPlayersContainer.innerHTML = `<p style="color: red;">Failed to initialize video players: ${error.message}</p>`;
      }
    }

    // --- 6. RENDER VIDEO PLAYERS ---
    function renderVideoPlayers(videoData) {
      // Fix: Handle the correct data structure from Firebase function
      if (!videoData || !videoData.success || !videoData.videoGroups) {
        videoPlayersContainer.innerHTML = '<p>No video data available.</p>';
        return;
      }

      const videoGroups = videoData.videoGroups;
      const videoIds = Object.keys(videoGroups);
      
      if (videoIds.length === 0) {
        videoPlayersContainer.innerHTML = '<p>No videos found.</p>';
        return;
      }

      let playersHtml = '';
      
      // Convert videoGroups object to array format for rendering
      videoIds.forEach((videoId, index) => {
        const videoGroup = videoGroups[videoId];
        const videoMetadata = videoGroup.metadata;
        const segments = videoGroup.segments;
        
        // Skip if no metadata available
        if (!videoMetadata) {
          console.warn(`No metadata available for video ${videoId}`);
          return;
        }
        
        const embedId = `player-${videoId}`;
        
        playersHtml += `
          <div class="video-container">
            <div class="video-title">${videoMetadata.title || 'JRE Episode'}</div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
              ${videoMetadata.channelTitle} • ${videoMetadata.viewCount ? parseInt(videoMetadata.viewCount).toLocaleString() + ' views' : ''} • ${videoMetadata.publishedAt ? new Date(videoMetadata.publishedAt).toLocaleDateString() : ''}
            </div>
            <iframe 
              id="${embedId}"
              class="video-embed"
              src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0"
              allowfullscreen>
            </iframe>
            <div class="segments-list">
              <div class="segments-header">Relevant Segments (${segments.length}):</div>
              ${segments.map((segment, segIndex) => `
                <div class="segment-item" onclick="seekToTime('${videoId}', ${segment.startTimeSeconds})">
                  <div class="segment-content">
                    <div class="segment-text">${segment.segmentText}</div>
                    <div class="segment-timestamp">${formatTime(segment.startTimeSeconds)} - ${formatTime(segment.endTimeSeconds)}</div>
                  </div>
                  <button class="timestamp-btn" onclick="event.stopPropagation(); seekToTime('${videoId}', ${segment.startTimeSeconds})">
                    ${formatTime(segment.startTimeSeconds)}
                  </button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      videoPlayersContainer.innerHTML = playersHtml;

      // Auto-seek to first relevant segment for each video
      videoIds.forEach(videoId => {
        const segments = videoGroups[videoId].segments;
        if (segments.length > 0) {
          const firstSegment = segments[0];
          // Add a small delay to allow iframe to load
          setTimeout(() => {
            seekToTime(videoId, firstSegment.startTimeSeconds);
          }, 2000);
        }
      });
    }

    // --- 7. UTILITY FUNCTIONS ---
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function seekToTime(videoId, startTime) {
      // For embedded YouTube players, we need to update the src to include the start time
      const iframe = document.getElementById(`player-${videoId}`);
      if (iframe) {
        const currentSrc = iframe.src;
        const baseUrl = currentSrc.split('?')[0] || currentSrc.split('&t=')[0];
        iframe.src = `${baseUrl}?enablejsapi=1&rel=0&t=${startTime}s`;
      }
    }

  </script>
</body>

</html>