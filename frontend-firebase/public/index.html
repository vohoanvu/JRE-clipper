<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>What would Joe Rogan say? - JRE Clipper</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <script src="https://cloud.google.com/ai/gen-app-builder/client?hl=en_US"></script>

  <!-- Firebase App is required and must be listed first -->
  <script defer src="/__/firebase/11.9.1/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/11.9.1/firebase-functions-compat.js"></script>

  <script defer src="/__/firebase/init.js"></script>

  <style media="screen">
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    
    body {
      font-family: "Pico", sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    main.container {
      flex: 1; /* This will make main take up available space */
      padding: 2rem;
      max-width: 1500px;
      margin: 0 auto;
      width: 95%;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .videos-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }

    @media (max-width: 768px) {
      .videos-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    .video-container {
      margin: 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
      height: fit-content;
    }

    .video-embed {
      width: 100%;
      height: 280px;
      border: none;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .video-embed {
        height: 240px;
      }
    }

    .segments-list {
      margin-top: 1rem;
    }

    .segment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .segment-item:hover {
      background: #f0f0f0;
    }

    .segment-item.selected {
      background: #e8f5e8;
      border-color: #28a745;
    }

    .segment-selection {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      min-width: fit-content;
    }

    .segment-checkbox {
      margin: 0;
      cursor: pointer;
    }

    .segment-checkbox-label {
      font-size: 0.8rem;
      color: #666;
      cursor: pointer;
      white-space: nowrap;
    }

    .segment-content {
      flex: 1;
      margin: 0 0.5rem;
    }

    @media (max-width: 768px) {
      .segment-item {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }

      .segment-selection {
        order: 1;
        justify-content: center;
      }

      .segment-content {
        order: 2;
        margin: 0;
        text-align: center;
      }

      .skip-btn {
        order: 3;
        align-self: center;
      }
    }

    .skip-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      text-transform: uppercase;
      max-width: fit-content;
    }

    .skip-btn:hover {
      background: #0056b3;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .video-title {
      color: #0066cc;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
    }

    .segments-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .answer-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .answer-header {
      font-size: 1.2rem;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .answer-content {
      font-size: 1rem;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
    }

    .answer-loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #666;
      font-style: italic;
    }

    .gemini-loading {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 0.5rem;
    }

    .gemini-loading .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: gemini-pulse 1.4s ease-in-out infinite;
    }

    .gemini-loading .dot:nth-child(1) {
      background: #4285F4; /* Google Blue */
      animation-delay: 0s;
    }

    .gemini-loading .dot:nth-child(2) {
      background: #EA4335; /* Google Red */
      animation-delay: 0.2s;
    }

    .gemini-loading .dot:nth-child(3) {
      background: #FBBC04; /* Google Yellow */
      animation-delay: 0.4s;
    }

    .gemini-loading .dot:nth-child(4) {
      background: #34A853; /* Google Green */
      animation-delay: 0.6s;
    }

    @keyframes gemini-pulse {
      0%, 60%, 100% {
        transform: scale(1);
        opacity: 0.7;
      }
      30% {
        transform: scale(1.4);
        opacity: 1;
      }
    }

    .answer-loading .dots::after {
      content: '';
      animation: dots 1.5s ease-in-out infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    .answer-error {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 1rem;
      border-radius: 4px;
    }

    .citations {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #dee2e6;
      font-size: 0.9rem;
      color: #666;
    }

    .citation {
      margin: 0.25rem 0;
    }

    /* Footer Styles - Ultra Compact Version */
    .footer {
      background: #2c3e50;
      color: #ecf0f1;
      border-top: 1px solid #34495e;
      padding: 0.75rem 0 0 0; /* Reduced from 1.5rem to 0.75rem */
      margin: 0; /* Ensure no margin */
      margin-top: auto; /* Push footer to bottom */
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem; /* Reduced horizontal padding */
      display: grid;
      grid-template-columns: 1fr 1fr; /* Changed to 2 columns */
      gap: 1rem; /* Reduced gap from 2rem to 1rem */
      justify-items: center; /* Center the content in each column */
    }

    @media (max-width: 768px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 0.5rem; /* Even smaller gap on mobile */
        padding: 0 0.5rem; /* Reduced mobile padding */
      }
    }

    .footer-section h3 {
      color: #3498db;
      margin-bottom: 0.25rem; /* Further reduced margin */
      font-size: 0.9rem; /* Even smaller font size */
    }

    .footer-section p {
      margin-bottom: 0.15rem; /* Further reduced margin */
      line-height: 1.3; /* Even tighter line height */
      font-size: 0.8rem; /* Smaller font size */
    }

    .footer-section a {
      color: #3498db;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .footer-section a:hover {
      color: #5dade2;
    }

    .footer-bottom {
      text-align: center;
      border-top: 1px solid #34495e;
      color: #95a5a6;
      padding: 0.4rem 0 0.3rem 0; /* Further reduced padding */
      font-size: 0.75rem; /* Even smaller font size */
      margin: 0; /* Ensure no margin */
    }

    .contact-links {
      list-style: none;
      padding: 0;
      margin: 0; /* Remove any default margin */
    }

    .contact-links li {
      margin-bottom: 0.15rem; /* Further reduced margin */
      font-size: 0.8rem; /* Smaller font size */
    }

    .contact-links i {
      margin-right: 0.5rem;
      width: 16px;
    }

    .pricing-highlight {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 0.6rem; /* Further reduced padding */
      border-radius: 4px; /* Smaller border radius */
      text-align: center;
    }

    .pricing-highlight h3 {
      color: white !important;
      margin-bottom: 0.25rem; /* Further reduced margin */
      font-size: 0.9rem; /* Smaller font size */
    }

    .pricing-highlight p {
      color: #f8f9fa;
      margin-bottom: 0.4rem; /* Further reduced margin */
      font-size: 0.75rem; /* Smaller font size */
      line-height: 1.2; /* Tighter line height */
    }

    .pricing-btn {
      display: inline-block;
      background: #fff;
      color: #2c3e50; /* Dark text for better contrast on white background */
      padding: 0.3rem 0.6rem; /* Further reduced padding */
      border-radius: 3px; /* Smaller border radius */
      text-decoration: none;
      font-weight: 600;
      font-size: 0.75rem; /* Smaller font size */
      transition: all 0.3s ease;
      border: 1px solid transparent; /* Thinner border */
    }

    .pricing-btn:hover {
      background: #f8f9fa;
      color: #1a252f; /* Even darker on hover */
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Smaller shadow */
    }

    /* Video Generation Controls */
    .video-generation-controls {
      background: #f8f9fa;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .video-generation-controls h3 {
      color: #28a745;
      margin-bottom: 0.5rem;
    }

    .generation-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    @media (max-width: 768px) {
      .generation-buttons {
        flex-direction: column;
        align-items: center;
      }
    }

    .generate-video-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }

    .generate-video-btn:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .generate-video-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .select-all-btn, .clear-selection-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .select-all-btn:hover {
      background: #0056b3;
    }

    .clear-selection-btn {
      background: #dc3545;
    }

    .clear-selection-btn:hover {
      background: #c82333;
    }

    .generation-status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
      display: none;
    }

    .generation-status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }

    .generation-status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      display: block;
    }

    .generation-status.processing {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      display: block;
    }

    /* Video Header with Controls */
    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .video-header {
        flex-direction: column;
        align-items: stretch;
      }
    }

    .video-title {
      color: #0066cc;
      font-size: 1.1rem;
      font-weight: bold;
      flex: 1;
    }

    .video-controls {
      flex-shrink: 0;
    }

    .select-video-btn {
      background: #6f42c1;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.3s ease;
      white-space: nowrap;
    }

    .select-video-btn:hover {
      background: #5a32a3;
    }
  </style>
</head>

<body>
  <main class="container">
    <h1>What would Joe Rogan say about...?</h1>
    <p>Enter a topic to find relevant segments from Joe Rogan Experience episodes with embedded video players and clickable timestamps.</p>

    <!-- The search input field and buttons -->
    <div style="display: flex; gap: 1rem;">
      <input type="search" placeholder="Authenticating, please wait..." id="searchInput" style="margin: 0;" disabled />
      <button id="searchButton" style="margin: 0;" disabled>Search</button>
      <div id="usage-counter" style="font-size: 0.9rem; color: #666; white-space: nowrap;">
        <span id="searches-remaining">10</span> searches left
      </div>
    </div>
    
    <!-- Container for AI-generated answer -->
    <div id="answer-section" style="margin-top: 2rem;"></div>

    <!-- Container for search results -->
    <div id="search-results" style="margin-top: 2rem;"></div>

    <!-- Container for video players -->
    <div id="video-players-container" style="margin-top: 2rem;"></div>

  </main>

  <!-- Footer Section -->
  <footer class="footer">
    <div class="footer-content">
      <!-- Developer Contact Section -->
      <div class="footer-section">
        <h3>👨‍💻 Developer Contact</h3>
        <ul class="contact-links">
          <li>📧 <a href="mailto:vohoanvu96@gmail.com">vohoanvu96@gmail.com</a></li>
          <li>🐙 <a href="https://github.com/vohoanvu" target="_blank">GitHub Profile</a></li>
          <li>💼 <a href="https://www.linkedin.com/in/thevuture/" target="_blank">LinkedIn</a></li>
        </ul>
      </div>

      <!-- Pricing Section -->
      <div class="footer-section">
        <div class="pricing-highlight">
          <h3>⚡ Upgrade Your Search</h3>
          <p>Free users: 10 searches per day<br>
          Unlimited searches with Pro!</p>
          <a href="/pricing.html" class="pricing-btn">View Pricing</a>
        </div>
      </div>

    </div>

    <div class="footer-bottom">
      <p>&copy; 2025 JRE Clipper. Built for educational purposes. Joe Rogan Experience content belongs to respective owners.</p>
    </div>
  </footer>

  <script>
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResultsContainer = document.getElementById('search-results');
    const answerSection = document.getElementById('answer-section');
    const videoPlayersContainer = document.getElementById('video-players-container');

    const tokenFunctionUrl = 'https://us-central1-gen-lang-client-demo.cloudfunctions.net/getVertexAiToken';
    const searchApiUrl = 'https://us-discoveryengine.googleapis.com/v1alpha/projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/servingConfigs/default_search:search';
    const answerApiUrl = 'https://us-discoveryengine.googleapis.com/v1alpha/projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/servingConfigs/default_search:answer';
    const videoProcessorUrl = 'https://jre-video-processor-py-408323719521.us-central1.run.app';

    let accessToken = null;
    let lastSearchResults = [];
    let currentSession = null;
    let currentQueryId = null;
    let players = {}; // Store YouTube player instances
    let userSessionId = null; // For anonymous users
    let selectedSegments = []; // Store selected segments for video generation
    let allSegments = []; // Store all available segments

    // Initialize session ID for anonymous users
    function initializeSession() {
      if (!userSessionId) {
        userSessionId = 'session_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
      }
    }

    // Server-side rate limiting functions
    async function checkServerRateLimit() {
      try {
        initializeSession();
        
        const checkLimit = firebase.functions().httpsCallable('checkSearchLimit');
        const result = await checkLimit({ 
          sessionId: userSessionId,
          userId: null // For now, we're using anonymous sessions
        });
        
        return result.data;
      } catch (error) {
        console.error('Error checking rate limit:', error);
        // Fallback to client-side limit if server fails
        return checkClientRateLimit();
      }
    }

    async function recordServerSearch() {
      try {
        initializeSession();
        
        const recordSearch = firebase.functions().httpsCallable('recordSearch');
        await recordSearch({ 
          sessionId: userSessionId,
          userId: null // For now, we're using anonymous sessions
        });
      } catch (error) {
        console.error('Error recording search:', error);
        // Fallback to client-side increment
        incrementClientSearchCount();
      }
    }

    // Fallback client-side rate limiting (kept for offline scenarios)
    function checkClientRateLimit() {
      const today = new Date().toDateString();
      let searchCount = parseInt(localStorage.getItem('jre_search_count') || '0');
      let lastReset = localStorage.getItem('jre_last_reset');
      let userPlan = localStorage.getItem('jre_user_plan') || 'free';
      
      // Reset if new day
      if (lastReset !== today) {
        searchCount = 0;
        localStorage.setItem('jre_search_count', '0');
        localStorage.setItem('jre_last_reset', today);
      }
      
      if (userPlan === 'pro') {
        return {
          allowed: true,
          plan: userPlan,
          remaining: null,
          message: 'Unlimited searches available'
        };
      }
      
      const remaining = Math.max(0, 10 - searchCount);
      return {
        allowed: remaining > 0,
        plan: userPlan,
        remaining: remaining,
        message: remaining > 0 ? `${remaining} searches remaining today` : 'Daily limit reached',
        showWarning: remaining <= 3 && remaining > 0
      };
    }

    function incrementClientSearchCount() {
      let userPlan = localStorage.getItem('jre_user_plan') || 'free';
      if (userPlan === 'free') {
        let searchCount = parseInt(localStorage.getItem('jre_search_count') || '0');
        localStorage.setItem('jre_search_count', (searchCount + 1).toString());
      }
    }

    // Rate limiting variables
    let userSearchCount = 0;
    const DAILY_SEARCH_LIMIT = 10;
    let lastResetDate = null;
    let userPlan = 'free'; // 'free' or 'pro'

    // Rate limiting functions
    function initializeRateLimit() {
      const today = new Date().toDateString();
      
      // Reset count if it's a new day
      if (lastResetDate !== today) {
        userSearchCount = 0;
        lastResetDate = today;
        localStorage.setItem('jre_search_count', '0');
        localStorage.setItem('jre_last_reset', today);
      } else {
        // Load from localStorage
        userSearchCount = parseInt(localStorage.getItem('jre_search_count') || '0');
        lastResetDate = localStorage.getItem('jre_last_reset');
      }
      
      // Load user plan (in real app, this would come from backend)
      userPlan = localStorage.getItem('jre_user_plan') || 'free';
      
      updateUsageDisplay();
    }

    function checkAndUpdateSearchLimit() {
      // Pro users have unlimited searches
      if (userPlan === 'pro') {
        return true;
      }
      
      const today = new Date().toDateString();
      
      // Reset count if it's a new day
      if (lastResetDate !== today) {
        userSearchCount = 0;
        lastResetDate = today;
        localStorage.setItem('jre_search_count', '0');
        localStorage.setItem('jre_last_reset', today);
        updateUsageDisplay();
      }
      
      return userSearchCount < DAILY_SEARCH_LIMIT;
    }

    function incrementSearchCount() {
      if (userPlan === 'free') {
        userSearchCount++;
        localStorage.setItem('jre_search_count', userSearchCount.toString());
        updateUsageDisplay();
      }
    }

    function getRemainingSearches() {
      if (userPlan === 'pro') {
        return 'Unlimited';
      }
      return Math.max(0, DAILY_SEARCH_LIMIT - userSearchCount);
    }

    function updateUsageDisplay() {
      const remaining = getRemainingSearches();
      const counterElement = document.getElementById('searches-remaining');
      
      if (userPlan === 'pro') {
        counterElement.textContent = '∞';
        counterElement.parentElement.innerHTML = '<span style="color: #28a745;">⚡ Pro Plan - Unlimited</span>';
      } else {
        counterElement.textContent = remaining;
        
        // Change color based on remaining searches
        if (remaining <= 2) {
          counterElement.style.color = '#e74c3c';
          counterElement.parentElement.style.background = '#ffe6e6';
          counterElement.parentElement.style.padding = '0.5rem';
          counterElement.parentElement.style.borderRadius = '4px';
        } else if (remaining <= 5) {
          counterElement.style.color = '#f39c12';
        } else {
          counterElement.style.color = '#28a745';
        }
      }
    }

    function showRateLimitWarning() {
      if (userPlan === 'pro') return; // No warnings for pro users
      
      const remaining = getRemainingSearches();
      
      // Remove any existing warnings
      const existingWarning = document.querySelector('.rate-limit-warning');
      if (existingWarning) {
        existingWarning.remove();
      }
      
      if (remaining <= 3 && remaining > 0) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'rate-limit-warning';
        warningDiv.innerHTML = `
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 4px; margin: 1rem 0; text-align: center;">
            <strong>⚠️ Search Limit Warning</strong><br>
            You have ${remaining} searches remaining today. <a href="/pricing.html" style="color: #0066cc; font-weight: bold;">Upgrade to Pro</a> for unlimited searches!
          </div>
        `;
        document.querySelector('main.container').insertBefore(warningDiv, document.getElementById('answer-section'));
        
        // Auto-remove warning after 8 seconds
        setTimeout(() => {
          if (warningDiv.parentNode) {
            warningDiv.remove();
          }
        }, 8000);
      }
    }

    function showRateLimitExceeded() {
      searchResultsContainer.innerHTML = `
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 2rem; border-radius: 8px; text-align: center; margin: 2rem 0;">
          <h3 style="color: #721c24; margin-bottom: 1rem;">🚫 Daily Search Limit Reached</h3>
          <p style="color: #721c24; margin-bottom: 1rem;">
            You've used all ${DAILY_SEARCH_LIMIT} free searches for today.
          </p>
          <p style="color: #721c24; margin-bottom: 1.5rem;">
            Your limit will reset at <strong>midnight UTC</strong> (${getTimeUntilReset()}).
          </p>
          <div style="margin-bottom: 1.5rem;">
            <strong>Want unlimited searches right now?</strong>
          </div>
          <a href="/pricing.html" style="display: inline-block; background: #28a745; color: white; padding: 1rem 2rem; text-decoration: none; border-radius: 6px; font-weight: bold; margin-bottom: 1rem;">
            ⚡ Upgrade to Pro - $9.99/month
          </a>
          <div style="margin-top: 1rem; font-size: 0.9rem; color: #6c757d;">
            ✓ Unlimited searches &nbsp; ✓ Advanced AI insights &nbsp; ✓ Priority support &nbsp; ✓ Cancel anytime
          </div>
          <div style="margin-top: 1rem;">
            <button onclick="simulateProUpgrade()" style="background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">
              🧪 Try Pro Mode (Demo)
            </button>
          </div>
        </div>
      `;
    }

    function getTimeUntilReset() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      
      const timeDiff = tomorrow - now;
      const hours = Math.floor(timeDiff / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      
      return `${hours}h ${minutes}m`;
    }

    // Demo function to simulate Pro upgrade
    function simulateProUpgrade() {
      userPlan = 'pro';
      localStorage.setItem('jre_user_plan', 'pro');
      updateUsageDisplay();
      
      // Clear rate limit message
      searchResultsContainer.innerHTML = `
        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 2rem; border-radius: 8px; text-align: center; margin: 2rem 0;">
          <h3 style="color: #155724; margin-bottom: 1rem;">🎉 Welcome to Pro!</h3>
          <p style="color: #155724; margin-bottom: 1rem;">
            You now have unlimited searches! Try searching again.
          </p>
          <p style="color: #155724; font-size: 0.9rem;">
            <em>This is a demo mode. In production, this would require payment via Stripe.</em>
          </p>
        </div>
      `;
      
      // Re-enable search
      searchInput.disabled = false;
      searchButton.disabled = false;
    }

    // --- 1. AUTHENTICATION ---
    // Initialize rate limiting first
    initializeRateLimit();
    
    fetch(tokenFunctionUrl)
      .then(response => {
        if (!response.ok) { 
          return response.json().then(err => { 
            throw new Error(`Auth Error: ${err.error || 'Unknown'}`); 
          }); 
        }
        return response.json();
      })
      .then(data => {
        if (data.accessToken) {
          accessToken = data.accessToken;
          searchInput.disabled = false;
          searchButton.disabled = false;
          searchInput.placeholder = "e.g. Jiu Jitsu, Bears, Bees, Aliens, Psychedelic Drugs";
        } else {
          searchInput.placeholder = "Authentication error. See console.";
          console.error("Could not fetch access token from backend.", data.error || '');
        }
      })
      .catch(error => {
        searchInput.placeholder = "Could not authenticate. See console.";
        console.error("Error fetching access token:", error);
      });

    // --- 2. SEARCH EVENT HANDLING ---
    searchButton.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query) performSearch(query);
    });

    searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const query = searchInput.value.trim();
        if (query) performSearch(query);
      }
    });

    // --- 3. PERFORM SEARCH ---
    async function performSearch(query) {
      if (!accessToken) { 
        console.error("Cannot search: Not authenticated."); 
        return; 
      }

      // Check server-side rate limit before proceeding
      const rateLimitCheck = await checkServerRateLimit();
      if (!rateLimitCheck.allowed) {
        showServerRateLimitExceeded(rateLimitCheck);
        return;
      }

      // Show warning if near limit
      if (rateLimitCheck.showWarning) {
        showRateLimitWarning(rateLimitCheck.remaining);
      }

      searchInput.placeholder = "Searching...";
      searchButton.setAttribute('aria-busy', 'true');
      searchResultsContainer.innerHTML = '';
      answerSection.innerHTML = '';
      videoPlayersContainer.innerHTML = '';

      fetch(searchApiUrl, {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${accessToken}`, 
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify({ 
          query: query, 
          pageSize: 20, 
          queryExpansionSpec: { condition: "AUTO" }, 
          spellCorrectionSpec: { mode: "AUTO" }, 
          languageCode: "en-US",
          userInfo: { timeZone: "Asia/Saigon" },
          session: "projects/408323719521/locations/us/collections/default_collection/engines/jreclipper_1750261043616/sessions/-"
        })
      })
        .then(response => {
          if (!response.ok) { 
            return response.json().then(err => { 
              throw new Error(`API Error: ${err.error.message}`); 
            }); 
          }
          return response.json();
        })
        .then(data => {
          // Only increment search count on successful search
          incrementSearchCount();
          
          lastSearchResults = data.results || [];
          
          // Extract session and queryId from the API response
          currentSession = data.sessionInfo?.name || null;
          currentQueryId = data.sessionInfo?.queryId || null;
          
          console.log('Search completed:', data);
          
          // Show rate limit warning if approaching limit
          showRateLimitWarning();
          
          if (lastSearchResults.length > 0) {
            // Generate AI answer first
            generateAnswer(query);
            // Then display search summary
            displaySearchSummary(lastSearchResults);
            // Finally load video players
            loadVideoPlayers(lastSearchResults);
          } else {
            displaySearchSummary(lastSearchResults);
          }
        })
        .catch(error => {
          console.error('Search failed:', error);
          searchResultsContainer.innerHTML = `<p style="color: red;">Search failed: ${error.message}</p>`;
        })
        .finally(() => {
          searchInput.placeholder = "e.g. Jiu Jitsu, Bears, Bees, Aliens";
          searchButton.removeAttribute('aria-busy');
        });
    }

    // --- 4. DISPLAY SEARCH SUMMARY ---
    function displaySearchSummary(results) {
      if (results.length === 0) {
        searchResultsContainer.innerHTML = '<p>No results found.</p>';
        return;
      }

      // Group results by video
      const videoGroups = {};
      results.forEach(item => {
        const videoId = item.document.structData.structData.videoId;
        const videoTitle = item.document.structData.structData.videoTitle;
        
        if (!videoGroups[videoId]) {
          videoGroups[videoId] = {
            title: videoTitle,
            segments: []
          };
        }
        
        videoGroups[videoId].segments.push(item);
      });

      const uniqueVideos = Object.keys(videoGroups);
      
      let html = `<h3>Found ${results.length} relevant segments from ${uniqueVideos.length} JRE episodes</h3>`;
      
      // Show video breakdown
      html += '<div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin: 1rem 0;">';
      Object.entries(videoGroups).forEach(([videoId, data]) => {
        html += `<div style="margin-bottom: 0.5rem; color: #2c3e50;">
          <strong>${data.title}</strong> - ${data.segments.length} segment${data.segments.length > 1 ? 's' : ''}
        </div>`;
      });
      html += '</div>';
      
      html += '<p style="color: #666; font-style: italic;">Watch the episode segments below...</p>';
      
      searchResultsContainer.innerHTML = html;
    }

    // --- 4.5. GENERATE AI ANSWER ---
    function generateAnswer(originalQuery) {
      if (!currentSession || !currentQueryId) {
        console.error('Cannot generate answer: Missing session or queryId');
        return;
      }

      answerSection.innerHTML = `
        <div class="answer-section">
          <div class="answer-header">
            🎙️ What Joe Rogan Would Say...
          </div>
          <div class="answer-loading">
            <div class="gemini-loading">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span>AI Joe Rogan is thinking<span class="dots"></span></span>
          </div>
        </div>
      `;

      const answerPayload = {
        query: {
          text: originalQuery,
          queryId: currentQueryId
        },
        session: currentSession,
        answerGenerationSpec: {
          ignoreAdversarialQuery: false,
          ignoreNonAnswerSeekingQuery: false,
          ignoreLowRelevantContent: false,
          multimodalSpec: {},
          includeCitations: true,
          promptSpec: {
            preamble: "You are an expert at the Joe Rogan Experience podcast and its content. You are very knowledgeable about JRE content and more importantly all of the guests that have appeared on the JRE show.\n\nUse Joe Rogan style of communication.\nUse the tone of professional comedians that are close to the Comedy circle of Joe Rogan.\n\nOccasionally at the end of every answer, make a joke about encouraging the users to take more psychedelic drugs and practice Martial Arts to learn more about the given topic. Use some funny emojis"
          },
          modelSpec: {
            modelVersion: "stable"
          }
        }
      };

      console.log('Generating answer with payload:', answerPayload);

      fetch(answerApiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(answerPayload)
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(`Answer API Error: ${err.error?.message || 'Unknown error'}`);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('Answer response:', data);
          displayAnswer(data);
        })
        .catch(error => {
          console.error('Answer generation failed:', error);
          answerSection.innerHTML = `
            <div class="answer-section">
              <div class="answer-header">
                🎙️ What Joe Rogan Would Say...
              </div>
              <div class="answer-error">
                Failed to generate answer: ${error.message}
              </div>
            </div>
          `;
        });
    }

    // --- 4.6. DISPLAY AI ANSWER ---
    function displayAnswer(answerData) {
      if (!answerData?.answer) {
        answerSection.innerHTML = `
          <div class="answer-section">
            <div class="answer-header">
              🎙️ What Joe Rogan Would Say...
            </div>
            <div class="answer-error">
              No answer generated. Try a different search query.
            </div>
          </div>
        `;
        return;
      }

      const answer = answerData.answer;
      let answerText = answer.answerText || 'No answer text available.';

      answerSection.innerHTML = `
        <div class="answer-section">
          <div class="answer-header">
            🎙️ What Joe Rogan Would Say About "${lastSearchResults.length > 0 ? searchInput.value : 'this topic'}"
          </div>
          <div class="answer-content">${answerText}</div>
        </div>
      `;
    }

    // --- 5. LOAD VIDEO PLAYERS ---
    function loadVideoPlayers(results) {
      videoPlayersContainer.innerHTML = '<div class="loading">Loading video players...</div>';

      // Prepare segments data for the backend
      const segmentData = results.map(item => {
        const data = item.document.structData.structData;
        // Extract start and end times from id (format: "videoId_startTime_endTime")
        const idParts = data.id ? data.id.split('_') : [];
        let startTime = idParts.length >= 2 ? parseInt(idParts[1]) : data.startTime;
        let endTime = idParts.length >= 3 ? parseInt(idParts[2]) : data.endTime;
        
        return {
          videoId: data.videoId,
          startTimeSeconds: startTime,
          endTimeSeconds: endTime,
          videoTitle: data.videoTitle,
          segmentText: item.document.structData.content
        };
      });

      // Store all segments globally for selection
      allSegments = segmentData;
      selectedSegments = []; // Reset selection
      updateGenerateVideoButton();

      // Wait for Firebase to be ready
      if (typeof firebase === 'undefined') {
        console.error("Firebase is not loaded");
        videoPlayersContainer.innerHTML = '<p style="color: red;">Firebase is not ready. Please refresh the page.</p>';
        return;
      }

      try {
        const getVideoMetadata = firebase.functions().httpsCallable('getVideoMetadata');
        
        getVideoMetadata({ segments: segmentData })
          .then((result) => {
            console.log("Got video metadata:", result.data);
            
            // Validate response structure
            if (!result.data || !result.data.success) {
              throw new Error(result.data?.error || 'Invalid response from video metadata service');
            }
            
            renderVideoPlayers(result.data);
          })
          .catch((error) => {
            console.error("Error fetching video metadata:", error);
            
            // Provide more specific error messages
            let errorMessage = 'Failed to load video players';
            if (error.code === 'permission-denied') {
              errorMessage = 'YouTube API access denied. Please check API key configuration.';
            } else if (error.code === 'resource-exhausted') {
              errorMessage = 'YouTube API quota exceeded. Please try again later.';
            } else if (error.message) {
              errorMessage += ': ' + error.message;
            }
            
            videoPlayersContainer.innerHTML = `<p style="color: red;">${errorMessage}</p>`;
          });
      } catch (error) {
        console.error("Error setting up metadata call:", error);
        videoPlayersContainer.innerHTML = `<p style="color: red;">Failed to initialize video players: ${error.message}</p>`;
      }
    }

    // --- 6. RENDER VIDEO PLAYERS ---
    function renderVideoPlayers(videoData) {
      // Fix: Handle the correct data structure from Firebase function
      if (!videoData || !videoData.success || !videoData.videoGroups) {
        videoPlayersContainer.innerHTML = '<p>No video data available.</p>';
        return;
      }

      const videoGroups = videoData.videoGroups;
      const videoIds = Object.keys(videoGroups);
      
      if (videoIds.length === 0) {
        videoPlayersContainer.innerHTML = '<p>No videos found.</p>';
        return;
      }

      let playersHtml = `
        <div class="video-generation-controls">
          <h3>🎬 Generate Custom Video Clips</h3>
          <p>Select segments below to generate a custom video compilation:</p>
          <div class="generation-buttons">
            <button id="generateVideoBtn" class="generate-video-btn" onclick="initiateVideoGeneration()" disabled>
              📹 Generate Video (0 segments selected)
            </button>
            <button class="select-all-btn" onclick="selectAllSegments()">
              ☑️ Select All Segments
            </button>
            <button class="clear-selection-btn" onclick="clearAllSelections()">
              ❌ Clear Selection
            </button>
          </div>
          <div id="generation-status" class="generation-status"></div>
        </div>
        <div class="videos-grid">`;
      
      // Convert videoGroups object to array format for rendering
      videoIds.forEach((videoId, index) => {
        const videoGroup = videoGroups[videoId];
        const videoMetadata = videoGroup.metadata;
        const segments = videoGroup.segments;
        
        // Skip if no metadata available
        if (!videoMetadata) {
          console.warn(`No metadata available for video ${videoId}`);
          return;
        }
        
        const embedId = `player-${videoId}`;
        
        playersHtml += `
          <div class="video-container">
            <div class="video-header">
              <div class="video-title">${videoMetadata.title || 'JRE Episode'}</div>
              <div class="video-controls">
                <button class="select-video-btn" onclick="toggleVideoSelection('${videoId}')">
                  📋 Select All (${segments.length})
                </button>
              </div>
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
              ${videoMetadata.channelTitle} • ${videoMetadata.viewCount ? parseInt(videoMetadata.viewCount).toLocaleString() + ' views' : ''} • ${videoMetadata.publishedAt ? new Date(videoMetadata.publishedAt).toLocaleDateString() : ''}
            </div>
            <iframe 
              id="${embedId}"
              class="video-embed"
              src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0"
              allowfullscreen>
            </iframe>
            <div class="segments-list">
              <div class="segments-header">Relevant Segments (${segments.length}):</div>
              ${segments.map((segment, segIndex) => {
                const segmentId = `${videoId}_${segment.startTimeSeconds}_${segment.endTimeSeconds}`;
                return `
                  <div class="segment-item">
                    <div class="segment-selection">
                      <input type="checkbox" 
                             id="segment_${segmentId}" 
                             class="segment-checkbox" 
                             data-video-id="${videoId}"
                             data-start="${segment.startTimeSeconds}"
                             data-end="${segment.endTimeSeconds}"
                             data-title="${videoMetadata.title || 'JRE Episode'}"
                             onchange="updateSelectedSegments()">
                      <label for="segment_${segmentId}" class="segment-checkbox-label">Select</label>
                    </div>
                    <div class="segment-content">
                      <div class="segment-timestamp-text">The search topic was mentioned at: ${formatTimeHMS(segment.startTimeSeconds)}</div>
                    </div>
                    <button class="skip-btn" onclick="seekToTime('${videoId}', ${segment.startTimeSeconds})">
                      SKIP TO
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });

      playersHtml += '</div>';
      videoPlayersContainer.innerHTML = playersHtml;

      // Note: Removed auto-seek functionality to prevent autoplay on page load
    }

    // --- 7. UTILITY FUNCTIONS ---
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function formatTimeHMS(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;
      
      if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      } else {
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
      }
    }

    function seekToTime(videoId, startTime) {
      console.log(`Seeking to time ${startTime} for video ${videoId}`);
      
      const iframe = document.getElementById(`player-${videoId}`);
      if (!iframe) {
        console.error(`Could not find iframe with id: player-${videoId}`);
        return;
      }
      
      // Create a new URL with the timestamp
      const baseUrl = `https://www.youtube.com/embed/${videoId}`;
      const params = new URLSearchParams({
        enablejsapi: '1',
        rel: '0',
        start: startTime,
        autoplay: '1'
      });
      const newSrc = `${baseUrl}?${params.toString()}`;
      
      console.log(`Updating iframe src to: ${newSrc}`);
      
      // Update the iframe source
      iframe.src = newSrc;
      
      // Scroll to the video player smoothly
      iframe.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // Optional: Add visual feedback
      const button = event?.target;
      if (button) {
        button.textContent = 'LOADING...';
        button.disabled = true;
        
        setTimeout(() => {
          button.textContent = 'SKIP TO';
          button.disabled = false;
        }, 2000);
      }
    }

    // --- 8. VIDEO GENERATION FUNCTIONS ---
    
    // Update selected segments based on checkbox states
    function updateSelectedSegments() {
      selectedSegments = [];
      const checkboxes = document.querySelectorAll('.segment-checkbox:checked');
      
      checkboxes.forEach(checkbox => {
        const segment = {
          videoId: checkbox.dataset.videoId,
          startTimeSeconds: parseInt(checkbox.dataset.start),
          endTimeSeconds: parseInt(checkbox.dataset.end),
          videoTitle: checkbox.dataset.title
        };
        selectedSegments.push(segment);
        
        // Add visual feedback
        checkbox.closest('.segment-item').classList.add('selected');
      });
      
      // Remove selected class from unchecked items
      document.querySelectorAll('.segment-checkbox:not(:checked)').forEach(checkbox => {
        checkbox.closest('.segment-item').classList.remove('selected');
      });
      
      updateGenerateVideoButton();
    }

    // Update the Generate Video button state
    function updateGenerateVideoButton() {
      const button = document.getElementById('generateVideoBtn');
      if (!button) return;
      
      const count = selectedSegments.length;
      button.textContent = `📹 Generate Video (${count} segment${count !== 1 ? 's' : ''} selected)`;
      button.disabled = count === 0;
      
      if (count === 0) {
        button.title = 'Select at least one segment to generate video';
      } else {
        button.title = `Generate video from ${count} selected segment${count !== 1 ? 's' : ''}`;
      }
    }

    // Select all segments
    function selectAllSegments() {
      const checkboxes = document.querySelectorAll('.segment-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
      updateSelectedSegments();
    }

    // Clear all selections
    function clearAllSelections() {
      const checkboxes = document.querySelectorAll('.segment-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      updateSelectedSegments();
    }

    // Toggle selection for all segments in a video
    function toggleVideoSelection(videoId) {
      const videoCheckboxes = document.querySelectorAll(`[data-video-id="${videoId}"]`);
      const checkedCount = document.querySelectorAll(`[data-video-id="${videoId}"]:checked`).length;
      const shouldCheck = checkedCount === 0;
      
      videoCheckboxes.forEach(checkbox => {
        checkbox.checked = shouldCheck;
      });
      
      updateSelectedSegments();
      
      // Update button text
      const button = document.querySelector(`button[onclick="toggleVideoSelection('${videoId}')"]`);
      if (button) {
        const totalSegments = videoCheckboxes.length;
        if (shouldCheck) {
          button.textContent = `✅ All Selected (${totalSegments})`;
        } else {
          button.textContent = `📋 Select All (${totalSegments})`;
        }
      }
    }

    // Show generation status
    function showGenerationStatus(message, type = 'processing') {
      const statusDiv = document.getElementById('generation-status');
      if (!statusDiv) return;
      
      statusDiv.className = `generation-status ${type}`;
      statusDiv.innerHTML = message;
    }

    // Hide generation status
    function hideGenerationStatus() {
      const statusDiv = document.getElementById('generation-status');
      if (statusDiv) {
        statusDiv.style.display = 'none';
      }
    }

    // Main function to initiate video generation
    async function initiateVideoGeneration() {
      if (selectedSegments.length === 0) {
        alert('Please select at least one segment to generate video.');
        return;
      }

      const button = document.getElementById('generateVideoBtn');
      const originalText = button.textContent;
      
      try {
        // Initialize session if needed
        initializeSession();
        
        // Disable button and show processing state
        button.disabled = true;
        button.textContent = '⚙️ Processing...';
        
        showGenerationStatus(`
          <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
            <div class="gemini-loading">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span>Initiating video generation job...</span>
          </div>
        `, 'processing');

        console.log('Sending video generation request:', {
          segments: selectedSegments,
          user_session_id: userSessionId
        });

        // Call the Cloud Run service
        const response = await fetch(`${videoProcessorUrl}/processVideoJob`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            segments: selectedSegments,
            user_session_id: userSessionId
          })
        });

        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }

        console.log('Video generation job created:', result);
        
        // Store the search query for potential return navigation
        localStorage.setItem('lastSearchQuery', searchInput.value || '');
        
        // Redirect to status page with job ID
        window.location.href = `status.html?jobId=${result.jobId}`;
        
      } catch (error) {
        console.error('Video generation failed:', error);
        
        showGenerationStatus(`
          <div>
            <h4>❌ Video Generation Failed</h4>
            <p><strong>Error:</strong> ${error.message}</p>
            <p style="margin-top: 1rem;">
              <strong>Possible solutions:</strong><br>
              • Check your internet connection<br>
              • Try selecting fewer segments<br>
              • Wait a moment and try again<br>
              • Make sure videos are publicly available
            </p>
            <button onclick="hideGenerationStatus()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Dismiss
            </button>
          </div>
        `, 'error');
        
      } finally {
        // Re-enable button
        button.disabled = selectedSegments.length === 0;
        button.textContent = originalText;
      }
    }

    // ...existing code...
  </script>
</body>

</html>