<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Video Generation Status - JRE Clipper</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

  <style media="screen">
    main {
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }

    #status-container {
      border: 1px solid #ccc;
      padding: 2rem;
      border-radius: 8px;
    }

    /* Vertical Stepper Styles */
    .stepper {
      position: relative;
      padding: 0;
      margin: 2rem 0;
    }

    .stepper-step {
      position: relative;
      padding: 1.5rem 0 1.5rem 4rem;
      border-left: 3px solid #e0e0e0;
      margin-left: 1.5rem;
    }

    .stepper-step:last-child {
      border-left-color: transparent;
    }

    .stepper-step.active {
      border-left-color: #2196F3;
    }

    .stepper-step.completed {
      border-left-color: #4CAF50;
    }

    .stepper-step.failed {
      border-left-color: #F44336;
    }

    .stepper-icon {
      position: absolute;
      left: -3rem;
      top: 1.5rem;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #e0e0e0;
      color: #757575;
      font-weight: bold;
      font-size: 1rem;
      border: 3px solid #e0e0e0;
    }

    .stepper-step.active .stepper-icon {
      background-color: #2196F3;
      border-color: #2196F3;
      color: white;
      animation: pulse 2s infinite;
    }

    .stepper-step.completed .stepper-icon {
      background-color: #4CAF50;
      border-color: #4CAF50;
      color: white;
    }

    .stepper-step.failed .stepper-icon {
      background-color: #F44336;
      border-color: #F44336;
      color: white;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .stepper-content {
      margin-left: 0.5rem;
    }

    .stepper-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      color: #333;
    }

    .stepper-step.active .stepper-title {
      color: #2196F3;
    }

    .stepper-step.completed .stepper-title {
      color: #4CAF50;
    }

    .stepper-step.failed .stepper-title {
      color: #F44336;
    }

    .stepper-description {
      color: #666;
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
    }

    .stepper-details {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .stepper-step.failed .stepper-details {
      background-color: #ffebee;
      border: 1px solid #f44336;
    }

    .stepper-step.active .stepper-details {
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
    }

    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #2196F3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced progress indicator for long tasks */
    .progress-indicator {
      display: flex;
      align-items: center;
      margin: 1rem 0;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      margin: 0 1rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2196F3, #21CBF3);
      border-radius: 3px;
      animation: progressPulse 2s ease-in-out infinite;
      transition: width 0.5s ease;
    }

    @keyframes progressPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* Enhanced progress indicator for real-time updates */
    .progress-indicator.realtime .progress-fill {
      background: linear-gradient(90deg, #4CAF50, #81C784);
      animation: realtimePulse 1.5s ease-in-out infinite;
    }

    @keyframes realtimePulse {
      0%, 100% { opacity: 0.8; box-shadow: 0 0 0 rgba(76, 175, 80, 0.4); }
      50% { opacity: 1; box-shadow: 0 0 10px rgba(76, 175, 80, 0.6); }
    }

    .time-estimate {
      background: #f0f8ff;
      border: 1px solid #2196F3;
      border-radius: 6px;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 0.85rem;
    }

    .time-estimate .icon {
      color: #2196F3;
      margin-right: 0.5rem;
      font-weight: bold;
    }

    .helpful-tips {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      padding: 1rem;
      margin: 1rem 0;
      font-size: 0.85rem;
    }

    .helpful-tips h4 {
      margin: 0 0 0.5rem 0;
      color: #856404;
      font-size: 0.9rem;
    }

    .helpful-tips ul {
      margin: 0.5rem 0 0 0;
      padding-left: 1.2rem;
    }

    .helpful-tips li {
      margin-bottom: 0.3rem;
      color: #856404;
    }

    /* Animated dots for long loading */
    .loading-dots::after {
      content: '';
      animation: dots 2s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    .job-info {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 2rem;
    }

    .job-info strong {
      color: #333;
    }

    .download-container {
      margin-top: 2rem;
      padding: 1.5rem;
      background-color: #e8f5e8;
      border: 1px solid #4caf50;
      border-radius: 8px;
      text-align: center;
      display: none;
    }

    .download-button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 1rem;
    }

    .download-button:hover {
      background-color: #45a049;
    }

    .error-actions {
      margin-top: 1rem;
    }

    .error-actions button {
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* Export button for downloaded videos */
    .export-container {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f0f8ff;
      border: 1px solid #2196F3;
      border-radius: 6px;
    }

    .export-button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 0.5rem;
      transition: background-color 0.2s;
    }

    .export-button:hover {
      background-color: #1976D2;
    }

    .export-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .export-info {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
  </style>
</head>

<body>
  <main class="container">
    <a href="index.html">‚Üê Back to Search</a>
    <h1>Video Generation Status</h1>

    <div id="status-container">
      <div class="job-info">
        <p><strong id="job-id-display">Job ID: Loading...</strong></p>
        <p><strong>Status:</strong> <span id="job-status">Initializing...</span></p>
        <p id="job-metrics"></p>
        <div style="margin-top: 1rem; padding: 0.75rem; background: #e8f4fd; border-radius: 4px; border-left: 4px solid #2196F3;">
          <strong>‚è∞ Expected Total Time:</strong> 25-45 minutes<br>
          <small style="color: #666;">This page will automatically update as your job progresses. You can safely close this tab and return later.</small>
        </div>
      </div>

      <!-- Vertical Stepper -->
      <div class="stepper" id="stepper">
        <div class="stepper-step" id="step-initiated">
          <div class="stepper-icon">1</div>
          <div class="stepper-content">
            <div class="stepper-title">Job Initiated</div>
            <div class="stepper-description">Video processing job created and queued</div>
          </div>
        </div>

        <div class="stepper-step" id="step-downloading">
          <div class="stepper-icon">2</div>
          <div class="stepper-content">
            <div class="stepper-title">Downloading Videos</div>
            <div class="stepper-description">Downloading source videos from YouTube (This may take 20-30 minutes)</div>
          </div>
        </div>

        <div class="stepper-step" id="step-downloaded">
          <div class="stepper-icon">3</div>
          <div class="stepper-content">
            <div class="stepper-title">Videos Downloaded</div>
            <div class="stepper-description">Full source videos are now available for export</div>
          </div>
        </div>

        <div class="stepper-step" id="step-processing">
          <div class="stepper-icon">4</div>
          <div class="stepper-content">
            <div class="stepper-title">Processing Segments</div>
            <div class="stepper-description">Extracting and compiling selected video segments</div>
          </div>
        </div>

        <div class="stepper-step" id="step-uploading">
          <div class="stepper-icon">5</div>
          <div class="stepper-content">
            <div class="stepper-title">Uploading Result</div>
            <div class="stepper-description">Uploading final video to cloud storage</div>
          </div>
        </div>

        <div class="stepper-step" id="step-complete">
          <div class="stepper-icon">‚úì</div>
          <div class="stepper-content">
            <div class="stepper-title">Complete</div>
            <div class="stepper-description">Video segments compilation is ready for download</div>
          </div>
        </div>
      </div>

      <!-- Download Container -->
      <div class="download-container" id="download-container">
        <h3>üéâ Your Video is Ready!</h3>
        <p>Your custom JRE compilation has been generated successfully.</p>
        <a id="download-button" class="download-button" href="#" target="_blank">
          üì• Download Video
        </a>
      </div>
    </div>

  </main>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const jobIdDisplay = document.getElementById('job-id-display');
      const jobStatus = document.getElementById('job-status');
      const jobMetrics = document.getElementById('job-metrics');
      const downloadContainer = document.getElementById('download-container');
      const downloadButton = document.getElementById('download-button');

      const videoProcessorUrl = 'https://jre-video-processor-py-408323719521.us-central1.run.app';
      
      // Store current job data and timing
      let currentJobData = null;
      let pollInterval = null;
      let eventSource = null;
      let downloadStartTime = null;
      let apifyProgressInterval = null;
      let lastApifyProgress = null;

      // 1. Get Job ID from URL
      const params = new URLSearchParams(window.location.search);
      const jobId = params.get('jobId');

      if (jobId) {
        jobIdDisplay.textContent = `Job ID: ${jobId}`;
        startStatusStream(jobId);
      } else {
        jobStatus.textContent = 'No Job ID provided in the URL.';
        jobIdDisplay.textContent = 'Job ID: Not Found';
        updateStepperUI({ status: 'Error', error: 'No job ID provided' });
      }

      // 2. Start Server-Sent Events for real-time status updates
      function startStatusStream(id) {
        console.log("Starting SSE stream for job:", id);

        // Set up Server-Sent Events connection
        const sseUrl = `https://us-central1-gen-lang-client-demo.cloudfunctions.net/streamJobStatus/${id}`;
        
        try {
          eventSource = new EventSource(sseUrl);
          
          eventSource.onopen = function(event) {
            console.log("SSE connection opened for job:", id);
            updateConnectionStatus('connected');
          };

          eventSource.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              console.log("Received SSE update:", data);
              
              switch (data.type) {
                case 'connected':
                  console.log("SSE connection confirmed for job:", data.jobId);
                  break;
                  
                case 'status':
                  currentJobData = data;
                  updateUI(data);
                  break;
                  
                case 'complete':
                  console.log("Job completed, SSE connection will close:", data.finalStatus);
                  break;
                  
                case 'ping':
                  // Keep-alive ping, no action needed
                  break;
                  
                case 'error':
                  console.error("SSE error:", data.error);
                  updateUI({ status: 'Error', error: data.error });
                  break;
                  
                default:
                  console.log("Unknown SSE message type:", data.type);
              }
            } catch (error) {
              console.error("Error parsing SSE data:", error, event.data);
            }
          };

          eventSource.onerror = function(event) {
            console.error("SSE connection error:", event);
            updateConnectionStatus('error');
            
            // Implement reconnection logic with exponential backoff
            if (eventSource.readyState === EventSource.CLOSED) {
              console.log("SSE connection closed, attempting to reconnect...");
              setTimeout(() => {
                if (!isJobFinished()) {
                  console.log("Reconnecting SSE...");
                  startStatusStream(id);
                }
              }, 5000); // Retry after 5 seconds
            }
          };

        } catch (error) {
          console.error("Failed to create SSE connection:", error);
          // Fallback to polling if SSE is not supported
          console.log("Falling back to polling...");
          startStatusPolling(id);
        }
      }

      // Fallback polling function (for browsers that don't support SSE)
      function startStatusPolling(id) {
        console.log("Starting fallback polling for job:", id);

        // Initial check
        checkJobStatus(id);

        // Start with frequent polling, then reduce frequency for long downloads
        let pollFrequency = 3000; // 3 seconds initially
        pollInterval = setInterval(() => {
          checkJobStatus(id);
          
          // If downloading for more than 5 minutes, reduce polling frequency
          if (currentJobData && currentJobData.status === 'Downloading' && downloadStartTime) {
            const downloadDuration = (Date.now() - downloadStartTime) / 1000 / 60;
            if (downloadDuration > 5) {
              // Reduce to polling every 10 seconds for long downloads
              if (pollFrequency === 3000) {
                clearInterval(pollInterval);
                pollFrequency = 10000;
                pollInterval = setInterval(() => checkJobStatus(id), pollFrequency);
                console.log("Reduced polling frequency for long download");
              }
            }
          }
        }, pollFrequency);
      }

      function updateConnectionStatus(status) {
        // You can add visual indicators for connection status here
        console.log("Connection status:", status);
      }

      // Function to poll Apify download progress
      function startApifyProgressPolling(jobId) {
        console.log("Starting Apify progress polling for job:", jobId);
        
        // Poll every 3 seconds during download phase
        apifyProgressInterval = setInterval(() => {
          pollApifyProgress(jobId);
        }, 10000);
        
        // Initial check
        pollApifyProgress(jobId);
      }

      function stopApifyProgressPolling() {
        if (apifyProgressInterval) {
          clearInterval(apifyProgressInterval);
          apifyProgressInterval = null;
          console.log("Stopped Apify progress polling");
        }
      }

      function pollApifyProgress(jobId) {
        fetch(`${videoProcessorUrl}/getApifyProgress?jobId=${jobId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (!response.ok) {
            // If endpoint returns 400, job might not have Apify run or be past download phase
            if (response.status === 400) {
              console.log("Job doesn't have Apify progress or is past download phase");
              stopApifyProgressPolling();
              return null;
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            console.log("Apify progress response:", data);
            lastApifyProgress = data;
            
            // Update download progress in UI
            updateDownloadProgress(data);
            
            // Stop polling if download is complete
            if (data.isDownloadComplete) {
              stopApifyProgressPolling();
            }
          }
        })
        .catch(error => {
          console.error("Error fetching Apify progress:", error);
          // Don't stop polling on temporary errors, but log them
        });
      }

      function updateDownloadProgress(progressData) {
        const downloadStep = document.getElementById('step-downloading');
        if (!downloadStep) return;
        
        // Only update if we're in downloading phase
        if (!currentJobData || currentJobData.status !== 'Downloading') return;
        
        // Find existing details or create new ones
        let details = downloadStep.querySelector('.stepper-details');
        if (!details) {
          details = document.createElement('div');
          details.className = 'stepper-details';
          downloadStep.querySelector('.stepper-content').appendChild(details);
        }
        
        const progress = progressData.downloadProgress || 0;
        const totalVideos = progressData.totalVideos || 1;
        const progressDetails = progressData.progressDetails || {};
        const apifyDetails = progressData.apifyDetails || {};
        
        // Create enhanced progress display with new structure
        details.innerHTML = `
          <div class="progress-indicator realtime">
            <span style="min-width: 50px; font-weight: bold; color: #2196F3;">${progress.toFixed(1)}%</span>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%; transition: width 0.5s ease;"></div>
            </div>
            <span style="min-width: 80px; text-align: right; font-size: 0.85rem; color: #666;">
              ${totalVideos} video${totalVideos !== 1 ? 's' : ''}
            </span>
          </div>
          
          <div class="time-estimate">
            <span class="icon">‚è±Ô∏è</span>
            <strong>${progressDetails.userFriendlyStatus || 'Downloading'}:</strong> ${progress.toFixed(1)}% complete
            ${progressDetails.elapsedTime ? `<br><small><strong>Elapsed:</strong> ${progressDetails.elapsedTime}</small>` : ''}
            ${progressDetails.estimatedCompletion ? `<br><small><strong>Remaining:</strong> ${progressDetails.estimatedCompletion}</small>` : ''}
          </div>
          
          ${progressDetails.statusMessage ? `
            <div style="background: #e3f2fd; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #2196F3;">
              <small><strong>üìä Current Status:</strong> ${progressDetails.statusMessage}</small>
            </div>
          ` : ''}
          
          ${progress > 0 ? `
            <div style="background: #e8f5e8; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #4caf50;">
              <small><strong>‚úÖ Progress Update:</strong> ${progressData.message || 'Downloading in progress...'}</small>
            </div>
          ` : ''}
          
          ${progressDetails.dataDownloaded || progressDetails.memoryUsage ? `
            <div class="helpful-tips">
              <h4>üìà Resource Usage</h4>
              <ul>
                ${progressDetails.dataDownloaded ? `<li><strong>Data Downloaded:</strong> ${progressDetails.dataDownloaded}</li>` : ''}
                ${progressDetails.memoryUsage ? `<li><strong>Memory Usage:</strong> ${progressDetails.memoryUsage}</li>` : ''}
                ${apifyDetails.stats && apifyDetails.stats.computeUnits ? `<li><strong>Compute Units:</strong> ${apifyDetails.stats.computeUnits}</li>` : ''}
              </ul>
            </div>
          ` : ''}
          
          <p class="loading-dots"><strong>Downloading videos from YouTube</strong></p>
          
          ${apifyDetails.runId ? `
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
              <strong>Technical Details:</strong><br>
              <strong>Apify Status:</strong> ${apifyDetails.status || 'Running'}<br>
              ${apifyDetails.startedAt ? `<strong>Started:</strong> ${new Date(apifyDetails.startedAt).toLocaleTimeString()}<br>` : ''}
              ${apifyDetails.stats && apifyDetails.stats.runTimeSecs ? `<strong>Runtime:</strong> ${Math.round(apifyDetails.stats.runTimeSecs / 60)}m ${Math.round(apifyDetails.stats.runTimeSecs % 60)}s<br>` : ''}
              <strong>Run ID:</strong> <code style="font-size: 0.7rem;">${apifyDetails.runId}</code>
            </div>
          ` : ''}
        `;
      }

      function isJobFinished() {
        return currentJobData && 
               (currentJobData.status === 'Complete' || 
                (currentJobData.status && currentJobData.status.startsWith('Failed') && 
                 !currentJobData.status.includes('Retry')));
      }

      function checkJobStatus(id) {
        console.log("Checking job status for:", id);

        // Use Python Cloud Run getJobStatus endpoint
        fetch(`${videoProcessorUrl}/getJobStatus?jobId=${id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Job status response:", data);
          currentJobData = data;
          updateUI(data);
        })
        .catch(error => {
          console.error("Error checking job status:", error);
          updateUI({
            status: 'Error',
            error: `Failed to check job status: ${error.message}`
          });
        });
      }

      function updateUI(jobData) {
        // Update basic info
        jobStatus.textContent = jobData.status || 'Unknown';
        
        // Update page title with status
        document.title = `${jobData.status || 'Processing'} - Video Generation Status - JRE Clipper`;
        
        if (jobData.totalVideos || jobData.totalSegments) {
          jobMetrics.innerHTML = `
            <strong>Videos:</strong> ${jobData.totalVideos || 'N/A'} | 
            <strong>Segments:</strong> ${jobData.totalSegments || 'N/A'}
          `;
        }

        // Start Apify progress polling if we're in downloading phase
        if (jobData.status === 'Downloading' && !apifyProgressInterval) {
          const params = new URLSearchParams(window.location.search);
          const jobId = params.get('jobId');
          if (jobId) {
            startApifyProgressPolling(jobId);
          }
        }
        
        // Stop Apify progress polling if we're no longer downloading
        if (jobData.status !== 'Downloading' && apifyProgressInterval) {
          stopApifyProgressPolling();
        }

        // Update stepper UI
        updateStepperUI(jobData);

        // Handle download link
        if (jobData.status === 'Complete' && jobData.finalVideoUrl) {
          downloadContainer.style.display = 'block';
          downloadButton.href = jobData.finalVideoUrl;
        }

        // Close SSE connection if job is complete or permanently failed
        if (jobData.status === 'Complete' || 
            (jobData.status && jobData.status.startsWith('Failed') && !jobData.status.includes('Retry'))) {
          if (eventSource) {
            eventSource.close();
            eventSource = null;
            console.log("Closed SSE connection - job finished");
          }
          if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
            console.log("Stopped polling - job finished");
          }
          // Also stop Apify polling
          stopApifyProgressPolling();
        }
      }

      function updateStepperUI(jobData) {
        const status = jobData.status || 'Unknown';
        const progressMessage = jobData.progressMessage || '';
        
        // Detect cache optimization scenarios
        const videosAlreadyAvailable = jobData.videosAlreadyAvailable || [];
        const videosNeedingDownload = jobData.videosNeedingDownload || [];
        const skipDownload = jobData.skipDownload || false;
        const totalVideos = jobData.totalVideos || 0;
        
        // Special handling for different cache scenarios
        let displayStatus = status;
        let cacheOptimized = false;
        
        if (skipDownload && videosAlreadyAvailable.length > 0) {
          // All videos were cached - processing started immediately
          cacheOptimized = true;
          if (status === 'Processing') {
            displayStatus = 'CachedProcessing';
          }
        } else if (videosAlreadyAvailable.length > 0 && videosNeedingDownload.length > 0) {
          // Partial cache - some videos cached, some downloading
          cacheOptimized = true;
          if (status === 'Downloading') {
            displayStatus = 'PartialCacheDownloading';
          }
        } else if (status === 'Processing' && 
                   (progressMessage.includes('download successful') || 
                    progressMessage.includes('Download completed') ||
                    progressMessage.includes('processing segments'))) {
          // Traditional flow - show downloaded state
          displayStatus = 'Downloaded';
        }
        
        const steps = {
          'step-initiated': document.getElementById('step-initiated'),
          'step-downloading': document.getElementById('step-downloading'),
          'step-downloaded': document.getElementById('step-downloaded'),
          'step-processing': document.getElementById('step-processing'),
          'step-uploading': document.getElementById('step-uploading'),
          'step-complete': document.getElementById('step-complete')
        };

        // Reset all steps
        Object.values(steps).forEach(step => {
          step.className = 'stepper-step';
          const details = step.querySelector('.stepper-details');
          if (details) details.remove();
        });

        // Update steps based on status
        switch (displayStatus) {
          case 'CachedProcessing':
            // All videos were cached - skip download phase entirely
            steps['step-initiated'].className = 'stepper-step completed';
            steps['step-downloading'].className = 'stepper-step completed';
            steps['step-downloaded'].className = 'stepper-step completed';
            steps['step-processing'].className = 'stepper-step active';
            
            addStepDetails(steps['step-downloading'], `
              <div class="time-estimate">
                <span class="icon">‚ö°</span>
                <strong>Download skipped!</strong> All ${videosAlreadyAvailable.length} videos were already in storage
              </div>
              <div class="helpful-tips">
                <h4>üöÄ Cache Optimization Active</h4>
                <ul>
                  <li>Videos were previously downloaded and cached</li>
                  <li>Skipping 20-30 minute download phase</li>
                  <li>Processing segments immediately</li>
                </ul>
              </div>
            `, 'completed');
            
            addStepDetails(steps['step-processing'], `
              <div class="progress-indicator">
                <div class="loading-spinner"></div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: 75%"></div>
                </div>
                <span>Processing</span>
              </div>
              <div class="time-estimate">
                <span class="icon">‚ö°</span>
                <strong>Fast processing!</strong> Extracting and compiling your selected segments
              </div>
              <p>${progressMessage || 'Processing cached video segments...'}</p>
            `, 'active');
            break;

          case 'PartialCacheDownloading':
            // Some videos cached, some downloading
            steps['step-initiated'].className = 'stepper-step completed';
            steps['step-downloading'].className = 'stepper-step active';
            
            // Track download start time
            if (!downloadStartTime) {
              downloadStartTime = Date.now();
            }
            
            const partialDownloadDuration = Math.floor((Date.now() - downloadStartTime) / 1000 / 60); // minutes
            const partialEstimatedTotal = Math.max(15, partialDownloadDuration + 10); // Reduced estimate due to partial cache
            
            // Use Apify progress data if available for partial downloads too
            let partialDownloadContent = '';
            if (lastApifyProgress && lastApifyProgress.downloadProgress !== undefined) {
              const apifyProgress = lastApifyProgress.downloadProgress;
              partialDownloadContent = `
                <div class="progress-indicator">
                  <span style="min-width: 50px; font-weight: bold; color: #2196F3;">${apifyProgress.toFixed(1)}%</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${apifyProgress}%; transition: width 0.5s ease;"></div>
                  </div>
                  <span style="min-width: 80px; text-align: right; font-size: 0.85rem; color: #666;">
                    ${videosNeedingDownload.length}/${totalVideos} videos
                  </span>
                </div>
                <div class="time-estimate">
                  <span class="icon">‚ö°</span>
                  <strong>Smart Download:</strong> ${apifyProgress.toFixed(1)}% complete
                  <br><small>Downloading ${videosNeedingDownload.length} of ${totalVideos} videos (${videosAlreadyAvailable.length} cached)</small>
                </div>
                <div style="background: #e8f5e8; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #4caf50;">
                  <strong>üöÄ Cache Optimization:</strong> ${videosAlreadyAvailable.length} videos already available, downloading ${videosNeedingDownload.length} remaining
                </div>
                ${lastApifyProgress.message ? `
                  <div style="background: #e3f2fd; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #2196F3;">
                    <small><strong>üìä Status:</strong> ${lastApifyProgress.message}</small>
                  </div>
                ` : ''}
                <p class="loading-dots"><strong>Downloading ${videosNeedingDownload.length} remaining videos</strong></p>
              `;
            } else {
              // Fallback content
              partialDownloadContent = `
                <div class="progress-indicator">
                  <div class="loading-spinner"></div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(85, (partialDownloadDuration / partialEstimatedTotal) * 100)}%"></div>
                  </div>
                  <span>${partialDownloadDuration} min</span>
                </div>
                <div class="time-estimate">
                  <span class="icon">‚ö°</span>
                  <strong>Optimized download:</strong> ${videosNeedingDownload.length} of ${totalVideos} videos downloading
                  ${partialDownloadDuration > 0 ? ` | Running for ${partialDownloadDuration} minutes` : ''}
                </div>
                <div style="background: #e8f5e8; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #4caf50;">
                  <strong>üöÄ Cache Hit:</strong> ${videosAlreadyAvailable.length} videos already available, only downloading ${videosNeedingDownload.length} missing videos
                </div>
                <div class="helpful-tips">
                  <h4>üí° Why is this faster?</h4>
                  <ul>
                    <li>Some videos were cached from previous requests</li>
                    <li>Estimated time: 10-20 minutes (reduced from 20-30)</li>
                    <li>Only downloading missing content</li>
                  </ul>
                </div>
                <p class="loading-dots"><strong>Downloading ${videosNeedingDownload.length} remaining videos</strong></p>
              `;
            }
            
            addStepDetails(steps['step-downloading'], partialDownloadContent, 'active');
            break;

          case 'Downloading':
            steps['step-initiated'].className = 'stepper-step completed';
            steps['step-downloading'].className = 'stepper-step active';
            
            // Track download start time
            if (!downloadStartTime) {
              downloadStartTime = Date.now();
            }
            
            const regDownloadDuration = Math.floor((Date.now() - downloadStartTime) / 1000 / 60); // minutes
            const regEstimatedTotal = Math.max(20, regDownloadDuration + 15); // At least 20 minutes estimate
            
            // Use Apify progress data if available, otherwise fall back to time-based estimation
            let downloadContent = '';
            if (lastApifyProgress && lastApifyProgress.downloadProgress !== undefined) {
              const apifyProgress = lastApifyProgress.downloadProgress;
              downloadContent = `
                <div class="progress-indicator">
                  <span style="min-width: 50px; font-weight: bold; color: #2196F3;">${apifyProgress.toFixed(1)}%</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${apifyProgress}%; transition: width 0.5s ease;"></div>
                  </div>
                  <span style="min-width: 80px; text-align: right; font-size: 0.85rem; color: #666;">
                    ${lastApifyProgress.totalVideos || 'N/A'} video${(lastApifyProgress.totalVideos || 1) !== 1 ? 's' : ''}
                  </span>
                </div>
                <div class="time-estimate">
                  <span class="icon">üìä</span>
                  <strong>Real-time Progress:</strong> ${apifyProgress.toFixed(1)}% complete
                  ${apifyProgress > 0 && apifyProgress < 100 ? `<br><small>Downloading ${lastApifyProgress.totalVideos || 'multiple'} video${(lastApifyProgress.totalVideos || 1) !== 1 ? 's' : ''} from YouTube...</small>` : ''}
                </div>
                ${lastApifyProgress.message ? `
                  <div style="background: #e8f5e8; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #4caf50;">
                    <small><strong>‚úÖ Status:</strong> ${lastApifyProgress.message}</small>
                  </div>
                ` : ''}
                <div class="helpful-tips">
                  <h4>üí° Live Download Progress:</h4>
                  <ul>
                    <li>Real-time progress from YouTube download engine</li>
                    <li>High-quality video files being processed</li>
                    <li>You can close this tab and return later - progress is saved</li>
                  </ul>
                </div>
                <p class="loading-dots"><strong>Downloading videos from YouTube</strong></p>
                ${lastApifyProgress.apifyDetails ? `
                  <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                    <strong>Download Engine:</strong> ${lastApifyProgress.apifyDetails.status || 'Running'}
                    ${lastApifyProgress.apifyDetails.startedAt ? `<br><strong>Started:</strong> ${new Date(lastApifyProgress.apifyDetails.startedAt).toLocaleTimeString()}` : ''}
                  </div>
                ` : ''}
              `;
            } else {
              // Fallback to time-based progress estimation
              const progressPercent = Math.min(85, (regDownloadDuration / regEstimatedTotal) * 100); // Cap at 85% until complete
              downloadContent = `
                <div class="progress-indicator">
                  <div class="loading-spinner"></div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                  </div>
                  <span>${regDownloadDuration} min</span>
                </div>
                <div class="time-estimate">
                  <span class="icon">‚è±Ô∏è</span>
                  <strong>Estimated time:</strong> 20-30 minutes total
                  ${regDownloadDuration > 0 ? `| Running for ${regDownloadDuration} minutes` : ''}
                </div>
                <div class="helpful-tips">
                  <h4>üí° Why does this take so long?</h4>
                  <ul>
                    <li>Downloading high-quality video files from YouTube</li>
                    <li>Processing ${jobData.totalVideos || 'multiple'} videos simultaneously</li>
                    <li>Your videos will be ready soon - feel free to close this tab and return later</li>
                  </ul>
                </div>
                <p class="loading-dots"><strong>Downloading videos</strong></p>
                <div style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid #ffc107;">
                  <small><strong>üí° Getting detailed progress...</strong> Connecting to download engine for real-time updates.</small>
                </div>
              `;
            }
            
            addStepDetails(steps['step-downloading'], downloadContent, 'active');
            break;

          case 'Downloaded':
            steps['step-initiated'].className = 'stepper-step completed';
            steps['step-downloading'].className = 'stepper-step completed';
            steps['step-downloaded'].className = 'stepper-step completed';
            
            addStepDetails(steps['step-downloaded'], `
              <div class="time-estimate">
                <span class="icon">‚úÖ</span>
                <strong>Download complete!</strong> Full source videos are now available
              </div>
              <div class="export-info">
                üí° You can now export the full source videos while segment processing continues in the background
              </div>
              <button id="export-source-videos-btn" class="export-button" onclick="exportSourceVideos()">
                üìÅ Export Full Source Videos
              </button>
              <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                Segment processing will continue automatically...
              </p>
            `, 'completed');
            
            // Also show step-processing as active if segments are being processed
            if (jobData.progressMessage && jobData.progressMessage.includes('processing segments')) {
              steps['step-processing'].className = 'stepper-step active';
              addStepDetails(steps['step-processing'], `
                <div class="progress-indicator">
                  <div class="loading-spinner"></div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 40%"></div>
                  </div>
                  <span>Processing</span>
                </div>
                <div class="time-estimate">
                  <span class="icon">‚ö°</span>
                  <strong>Processing segments...</strong> Extracting your selected clips
                </div>
              `, 'active');
            }
            break;

          case 'Processing':
            steps['step-initiated'].className = 'stepper-step completed';
            steps['step-downloading'].className = 'stepper-step completed';
            steps['step-downloaded'].className = 'stepper-step completed';
            steps['step-processing'].className = 'stepper-step active';
            
            addStepDetails(steps['step-processing'], `
              <div class="progress-indicator">
                <div class="loading-spinner"></div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: 60%"></div>
                </div>
                <span>Processing</span>
              </div>
              <div class="time-estimate">
                <span class="icon">‚ö°</span>
                <strong>Almost done!</strong> Extracting and compiling your selected segments
              </div>
              <p>${jobData.progressMessage || 'Processing video segments...'}</p>
            `, 'active');
            break;

          case 'Uploading':
            steps['step-initiated'].className = 'stepper-step completed';
            steps['step-downloading'].className = 'stepper-step completed';
            steps['step-downloaded'].className = 'stepper-step completed';
            steps['step-processing'].className = 'stepper-step completed';
            steps['step-uploading'].className = 'stepper-step active';
            
            addStepDetails(steps['step-uploading'], `
              <div class="progress-indicator">
                <div class="loading-spinner"></div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: 90%"></div>
                </div>
                <span>Uploading</span>
              </div>
              <div class="time-estimate">
                <span class="icon">‚òÅÔ∏è</span>
                <strong>Final step:</strong> Uploading your video to cloud storage
              </div>
              <p class="loading-dots">Uploading final video</p>
            `, 'active');
            break;

          case 'Complete':
            Object.values(steps).forEach(step => {
              step.className = 'stepper-step completed';
            });
            
            // Create complete step content with final video URL
            let completeContent = `
              <div class="time-estimate">
                <span class="icon">üéâ</span>
                <strong>Video generation completed successfully!</strong>
              </div>
            `;
            
            // Add final video download section if available
            if (jobData.finalVideoUrl) {
              completeContent += `
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 4px; border: 1px solid #4caf50; margin: 1rem 0;">
                  <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;">üé¨ Your Final Video is Ready!</h4>
                  <a href="${jobData.finalVideoUrl}" target="_blank" 
                     style="background: #4caf50; color: white; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: bold; margin: 0.5rem 0;">
                    üì• Download Final Video
                  </a>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #666;">
                    üí° Right-click and "Save As" to download to your device
                  </p>
                </div>
              `;
            } else {
              completeContent += `
                <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; border: 1px solid #ffc107; margin: 1rem 0;">
                  <p style="margin: 0; color: #856404;">
                    ‚è≥ Final video URL is being prepared. Please refresh the page in a moment.
                  </p>
                </div>
              `;
            }
            
            // Add cache optimization summary if applicable
            if (cacheOptimized) {
              const totalCached = videosAlreadyAvailable.length;
              const totalDownloaded = videosNeedingDownload.length;
              
              completeContent += `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; border: 1px solid #2196f3; margin: 1rem 0;">
                  <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">‚ö° Cache Optimization Summary</h4>
                  <ul style="margin: 0.5rem 0; padding-left: 1.25rem;">
                    ${totalCached > 0 ? `<li><strong>${totalCached} videos</strong> were already cached (saved ~${Math.floor(totalCached * 2.5)} minutes)</li>` : ''}
                    ${totalDownloaded > 0 ? `<li><strong>${totalDownloaded} videos</strong> were downloaded fresh</li>` : ''}
                    <li>Total processing time was significantly reduced</li>
                  </ul>
                </div>
              `;
            }
            
            // Add helpful next steps
            completeContent += `
              <div class="helpful-tips">
                <h4>üéØ What's Next?</h4>
                <ul>
                  <li>Your personalized JRE compilation video is ready to download</li>
                  <li>Share it with friends or save it for later viewing</li>
                  <li>Create more compilations by searching for different topics</li>
                </ul>
              </div>
              <div style="text-align: center; margin-top: 1rem;">
                <button onclick="goBackToSelection()" style="background: #2196f3; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: bold;">
                  üîç Create Another Compilation
                </button>
              </div>
            `;
            
            addStepDetails(steps['step-complete'], completeContent, 'completed');
            break;

          case 'Failed':
          case 'Error':
            // Mark current step as failed based on progress (use original status for error detection)
            let failedStep = steps['step-initiated'];
            if (status.includes('download') || jobData.error?.includes('download')) {
              failedStep = steps['step-downloading'];
              steps['step-initiated'].className = 'stepper-step completed';
            } else if (status.includes('process') || jobData.error?.includes('process')) {
              failedStep = steps['step-processing'];
              steps['step-initiated'].className = 'stepper-step completed';
              steps['step-downloading'].className = 'stepper-step completed';
              steps['step-downloaded'].className = 'stepper-step completed';
            } else if (status.includes('upload') || jobData.error?.includes('upload')) {
              failedStep = steps['step-uploading'];
              steps['step-initiated'].className = 'stepper-step completed';
              steps['step-downloading'].className = 'stepper-step completed';
              steps['step-downloaded'].className = 'stepper-step completed';
              steps['step-processing'].className = 'stepper-step completed';
            }
            
            failedStep.className = 'stepper-step failed';
            const errorMsg = jobData.error || 'An unknown error occurred';
            addStepDetails(failedStep, 
              `‚ùå ${errorMsg}${getErrorSuggestions(errorMsg)}`, 
              'failed');
            break;

          default: // Queued, Unknown, etc.
            steps['step-initiated'].className = 'stepper-step active';
            addStepDetails(steps['step-initiated'], `
              <div class="progress-indicator">
                <div class="loading-spinner"></div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: 10%"></div>
                </div>
                <span>Starting</span>
              </div>
              <div class="time-estimate">
                <span class="icon">üöÄ</span>
                <strong>Getting ready...</strong> Your job is queued and will start shortly
              </div>
              <div class="helpful-tips">
                <h4>üìã What happens next:</h4>
                <ul>
                  <li><strong>Step 1:</strong> Download videos from YouTube (20-30 min)</li>
                  <li><strong>Step 2:</strong> Videos ready - export option available</li>
                  <li><strong>Step 3:</strong> Extract your selected segments (5-10 min)</li>
                  <li><strong>Step 4:</strong> Upload final video (2-5 min)</li>
                </ul>
              </div>
              <p class="loading-dots">Initializing job</p>
            `, 'active');
        }
      }

      function addStepDetails(stepElement, content, type) {
        const existingDetails = stepElement.querySelector('.stepper-details');
        if (existingDetails) existingDetails.remove();
        
        const details = document.createElement('div');
        details.className = 'stepper-details';
        details.innerHTML = content;
        stepElement.querySelector('.stepper-content').appendChild(details);
      }

      function getErrorSuggestions(errorMsg) {
        if (errorMsg.includes('bot') || errorMsg.includes('rate limit')) {
          return `
            <div class="error-actions">
              <p><strong>üí° Suggestions:</strong></p>
              <ul>
                <li>Try selecting fewer video segments</li>
                <li>Wait 10-15 minutes before retrying</li>
                <li>YouTube may be blocking automated requests</li>
              </ul>
              <button onclick="goBackToSelection()" style="background: #2196F3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                ‚Üê Select Different Segments
              </button>
            </div>
          `;
        } else if (errorMsg.includes('private') || errorMsg.includes('unavailable')) {
          return `
            <div class="error-actions">
              <p><strong>üí° Suggestions:</strong></p>
              <ul>
                <li>One or more videos may be private or deleted</li>
                <li>Try searching for different content</li>
                <li>Check if the original videos are still available</li>
              </ul>
              <button onclick="goBackToSelection()" style="background: #2196F3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                ‚Üê Try Different Videos
              </button>
            </div>
          `;
        } else {
          return `
            <div class="error-actions">
              <p><strong>üí° You can:</strong></p>
              <button onclick="location.reload()" style="background: #ff9800; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                üîÑ Retry Job
              </button>
              <button onclick="goBackToSelection()" style="background: #2196F3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                ‚Üê Start New Job
              </button>
            </div>
          `;
        }
      }

      // Global function to go back to selection
      window.goBackToSelection = function() {
        const searchQuery = localStorage.getItem('lastSearchQuery') || '';
        window.location.href = `index.html?showSelection=true&query=${encodeURIComponent(searchQuery)}`;
      };

      // Global function to export source videos
      window.exportSourceVideos = function() {
        // Get jobId from URL
        const params = new URLSearchParams(window.location.search);
        const jobId = params.get('jobId');
        
        if (!jobId) {
          alert('No job ID found');
          return;
        }
        
        const button = event.target;
        const originalText = button.textContent;
        
        // Disable button and show loading state
        button.disabled = true;
        button.textContent = 'üîÑ Preparing Export...';
        
        console.log('Requesting source video export for job:', jobId);
        
        // Call the backend endpoint to get source video URLs
        fetch(`${videoProcessorUrl}/getSourceVideos?jobId=${jobId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to get source videos: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Source videos response:', data);
          
          if (data.sourceVideos && data.sourceVideos.length > 0) {
            // Create download links for each video
            const downloadContainer = document.createElement('div');
            downloadContainer.style.marginTop = '1rem';
            downloadContainer.innerHTML = `
              <div style="background: #e8f5e8; padding: 1rem; border-radius: 4px; border: 1px solid #4caf50;">
                <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;">üìÅ Full Source Videos Available:</h4>
                ${data.sourceVideos.map((video, index) => `
                  <div style="margin: 0.5rem 0;">
                    <a href="${video.url}" target="_blank" 
                       style="background: #4caf50; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; display: inline-block; margin-right: 0.5rem;">
                      üì• Download Video ${index + 1} (${video.title || video.videoId})
                    </a>
                  </div>
                `).join('')}
                <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #666;">
                  üí° Right-click and "Save As" to download to your device
                </p>
              </div>
            `;
            
            // Replace the export button with download links
            button.parentNode.replaceChild(downloadContainer, button);
            
            // Show success message
            console.log('Source video export prepared successfully');
            
          } else {
            throw new Error('No source videos available for export');
          }
        })
        .catch(error => {
          console.error('Error exporting source videos:', error);
          
          // Re-enable button and show error
          button.disabled = false;
          button.textContent = originalText;
          button.style.backgroundColor = '#f44336';
          button.textContent = '‚ùå Export Failed';
          
          setTimeout(() => {
            button.style.backgroundColor = '#2196F3';
            button.textContent = originalText;
          }, 3000);
        });
      };

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (eventSource) {
          eventSource.close();
        }
        if (pollInterval) {
          clearInterval(pollInterval);
        }
        if (apifyProgressInterval) {
          clearInterval(apifyProgressInterval);
        }
      });
    });
  </script>
</body>

</html>
