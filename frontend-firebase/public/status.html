<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Video Generation Status - JRE Clipper</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

  <style media="screen">
    main {
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }

    #status-container {
      border: 1px solid #ccc;
      padding: 2rem;
      border-radius: 8px;
    }

    .progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-inner {
      height: 20px;
      width: 0%;
      /* Starts at 0% */
      background-color: #4caf50;
      text-align: center;
      line-height: 20px;
      color: white;
    }

    .error-container {
      background-color: #ffebee;
      border: 1px solid #f44336;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      display: none;
    }

    .download-container {
      margin-top: 2rem;
      display: none;
    }
  </style>
</head>

<body>
  <main class="container">
    <a href="index.html">‚Üê Back to Search</a>
    <h1>Video Generation Status</h1>

    <div id="status-container">
      <p><strong id="job-id-display">Job ID: Loading...</strong></p>
      <p><strong>Status:</strong> <span id="job-status">Initializing...</span></p>
      <p><strong>Video Title:</strong> <span id="job-title-text">Loading...</span></p>

      <!-- Progress Bar -->
      <div id="progress-container" style="display: none;">
        <p><strong>Progress:</strong></p>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progress-bar-inner">0%</div>
        </div>
        <p id="progress-message">Preparing...</p>
      </div>

      <!-- Error Container -->
      <div class="error-container" id="error-container">
        <h3>Error</h3>
        <p id="error-message"></p>
      </div>

      <!-- Download Container -->
      <div class="download-container" id="download-container">
        <h3>Video Ready!</h3>
        <button id="download-button" onclick="downloadVideo()">Download Video</button>
      </div>
    </div>

  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const jobIdDisplay = document.getElementById('job-id-display');
      const jobStatus = document.getElementById('job-status');
      const jobTitleText = document.getElementById('job-title-text');
      const progressContainer = document.getElementById('progress-container');
      const progressBarInner = document.getElementById('progress-bar-inner');
      const progressMessage = document.getElementById('progress-message');
      const errorContainer = document.getElementById('error-container');
      const errorMessage = document.getElementById('error-message');
      const downloadContainer = document.getElementById('download-container');

      // 1. Get Job ID from URL
      const params = new URLSearchParams(window.location.search);
      const jobId = params.get('jobId');

      if (jobId) {
        jobIdDisplay.textContent = `Job ID: ${jobId}`;
        listenForStatusChanges(jobId);
      } else {
        jobStatus.textContent = 'No Job ID provided in the URL.';
        jobIdDisplay.textContent = 'Job ID: Not Found';
      }

      // 2. Poll for status updates using the existing Cloud Function
      function listenForStatusChanges(id) {
        console.log("Setting up status polling for job:", id);

        // Initial check
        checkJobStatus(id);

        // Poll every 3 seconds
        window.pollInterval = setInterval(() => {
          checkJobStatus(id);
        }, 3000);
      }

      function checkJobStatus(id) {
        console.log("Checking job status for:", id);

        // Use the existing getVertexAiToken function URL but with jobId in body
        fetch('https://us-central1-gen-lang-client-demo.cloudfunctions.net/getVertexAiToken', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ jobId: id })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.error) {
              throw new Error(data.error);
            }
            console.log("Job status received:", data.jobData);
            updateUI(data.jobData);

            // Stop polling if job is complete or failed
            if (data.jobData.status === 'Complete' || data.jobData.status === 'Failed') {
              if (window.pollInterval) {
                clearInterval(window.pollInterval);
                window.pollInterval = null;
              }
            }
          })
          .catch(error => {
            console.error("Error getting job status:", error);
            jobStatus.textContent = 'Error';
            errorMessage.textContent = `Job with ID ${id} not found.`;
            errorContainer.style.display = 'block';

            // Stop polling on error
            if (window.pollInterval) {
              clearInterval(window.pollInterval);
              window.pollInterval = null;
            }
          });
      }

      function updateUI(jobData) {
        jobStatus.textContent = jobData.status || 'Unknown';
        jobTitleText.textContent = jobData.videoTitle || 'Unknown';

        // Handle different statuses
        if (jobData.status === 'Queued') {
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '10%';
          progressBarInner.textContent = '10%';
          progressMessage.textContent = 'Job queued, waiting to start...';
        } else if (jobData.status === 'Processing') {
          progressContainer.style.display = 'block';
          const progress = jobData.progress || 50;
          progressBarInner.style.width = progress + '%';
          progressBarInner.textContent = progress + '%';
          progressMessage.textContent = jobData.progressMessage || 'Processing video segments...';
        } else if (jobData.status === 'Complete') {
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '100%';
          progressBarInner.textContent = '100%';
          progressMessage.textContent = 'Video generation complete!';

          if (jobData.finalVideoUrl) {
            downloadContainer.style.display = 'block';
          }
        } else if (jobData.status === 'Failed') {
          errorContainer.style.display = 'block';
          errorMessage.textContent = jobData.error || 'Unknown error occurred.';
        }
      }

      // Make downloadVideo function globally accessible
      window.downloadVideo = function () {
        // Implementation for downloading video
        alert('Download functionality will be implemented when video processing is complete.');
      };
    });
  </script>
</body>

</html>