<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Video Generation Status - JRE Clipper</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

  <style media="screen">
    main {
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }

    #status-container {
      border: 1px solid #ccc;
      padding: 2rem;
      border-radius: 8px;
    }

    .progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-inner {
      height: 20px;
      width: 0%;
      /* Starts at 0% */
      background-color: #4caf50;
      text-align: center;
      line-height: 20px;
      color: white;
    }

    .error-container {
      background-color: #ffebee;
      border: 1px solid #f44336;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      display: none;
    }

    .retry-container {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      display: none;
    }

    .suggestions-container {
      background-color: #e8f5e8;
      border: 1px solid #4caf50;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .download-container {
      margin-top: 2rem;
      display: none;
    }
  </style>
</head>

<body>
  <main class="container">
    <a href="index.html">‚Üê Back to Search</a>
    <h1>Video Generation Status</h1>

    <div id="status-container">
      <p><strong id="job-id-display">Job ID: Loading...</strong></p>
      <p><strong>Status:</strong> <span id="job-status">Initializing...</span></p>
      <p><strong>Video Title:</strong> <span id="job-title-text">Loading...</span></p>

      <!-- Progress Bar -->
      <div id="progress-container" style="display: none;">
        <p><strong>Progress:</strong></p>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progress-bar-inner">0%</div>
        </div>
        <p id="progress-message">Preparing...</p>
      </div>

      <!-- Error Container -->
      <div class="error-container" id="error-container">
        <h3>‚ùå Processing Failed</h3>
        <p id="error-message"></p>
      </div>

      <!-- Retry Container (for bot detection errors) -->
      <div class="retry-container" id="retry-container">
        <h3>‚ö†Ô∏è YouTube Rate Limiting Detected</h3>
        <p id="retry-message"></p>
        <div class="suggestions-container" id="suggestions-container">
          <p><strong>üí° Suggestion:</strong> <span id="suggestions-text"></span></p>
        </div>
        <div style="margin-top: 1rem;">
          <button id="try-fewer-videos-btn" onclick="goBackToSelection()">
            üîÑ Try with Fewer Videos
          </button>
          <button id="wait-and-retry-btn" onclick="retryCurrentJob()" style="margin-left: 0.5rem;">
            ‚è≥ Wait & Retry Same Videos
          </button>
        </div>
      </div>

      <!-- Download Container -->
      <div class="download-container" id="download-container">
        <h3>Video Ready!</h3>
        <button id="download-button" onclick="downloadVideo()">Download Video</button>
      </div>
    </div>

  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const jobIdDisplay = document.getElementById('job-id-display');
      const jobStatus = document.getElementById('job-status');
      const jobTitleText = document.getElementById('job-title-text');
      const progressContainer = document.getElementById('progress-container');
      const progressBarInner = document.getElementById('progress-bar-inner');
      const progressMessage = document.getElementById('progress-message');
      const errorContainer = document.getElementById('error-container');
      const errorMessage = document.getElementById('error-message');
      const retryContainer = document.getElementById('retry-container');
      const retryMessage = document.getElementById('retry-message');
      const suggestionsContainer = document.getElementById('suggestions-container');
      const suggestionsText = document.getElementById('suggestions-text');
      const downloadContainer = document.getElementById('download-container');

      // Store current job data for retry functionality
      let currentJobData = null;

      // 1. Get Job ID from URL
      const params = new URLSearchParams(window.location.search);
      const jobId = params.get('jobId');

      if (jobId) {
        jobIdDisplay.textContent = `Job ID: ${jobId}`;
        listenForStatusChanges(jobId);
      } else {
        jobStatus.textContent = 'No Job ID provided in the URL.';
        jobIdDisplay.textContent = 'Job ID: Not Found';
      }

      // 2. Poll for status updates using the existing Cloud Function
      function listenForStatusChanges(id) {
        console.log("Setting up status polling for job:", id);

        // Initial check
        checkJobStatus(id);

        // Poll every 3 seconds
        window.pollInterval = setInterval(() => {
          checkJobStatus(id);
        }, 3000);
      }

      function checkJobStatus(id) {
        console.log("Checking job status for:", id);

        // Use the dedicated getJobStatus function endpoint
        fetch('https://us-central1-gen-lang-client-demo.cloudfunctions.net/getJobStatus', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ jobId: id })
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => {
                throw new Error(err.error || `HTTP ${response.status}`);
              });
            }
            return response.json();
          })
          .then(data => {
            console.log("Job status received:", data.jobData);
            updateUI(data.jobData);

            // Stop polling if job is complete or failed
            if (data.jobData.status === 'Complete' || data.jobData.status === 'Failed') {
              if (window.pollInterval) {
                clearInterval(window.pollInterval);
                window.pollInterval = null;
              }
            }
          })
          .catch(error => {
            console.error("Error getting job status:", error);
            jobStatus.textContent = 'Error';
            
            if (error.message.includes('Job not found')) {
              errorMessage.textContent = `Job with ID ${id} not found.`;
            } else {
              errorMessage.textContent = `Could not connect to status updates: ${error.message}`;
            }
            
            errorContainer.style.display = 'block';

            // Stop polling on error
            if (window.pollInterval) {
              clearInterval(window.pollInterval);
              window.pollInterval = null;
            }
          });
      }

      function updateUI(jobData) {
        currentJobData = jobData; // Store for retry functionality
        jobStatus.textContent = jobData.status || 'Unknown';
        jobTitleText.textContent = jobData.videoTitle || 'Unknown';

        // Hide all containers first
        progressContainer.style.display = 'none';
        errorContainer.style.display = 'none';
        retryContainer.style.display = 'none';
        downloadContainer.style.display = 'none';

        // Handle different statuses
        if (jobData.status === 'Queued') {
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '10%';
          progressBarInner.textContent = '10%';
          progressMessage.textContent = 'Job queued, waiting to start...';
        } else if (jobData.status === 'Processing') {
          progressContainer.style.display = 'block';
          const progress = jobData.progress || 50;
          progressBarInner.style.width = progress + '%';
          progressBarInner.textContent = progress + '%';
          progressMessage.textContent = jobData.progressMessage || 'Processing video segments...';
        } else if (jobData.status === 'Complete') {
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '100%';
          progressBarInner.textContent = '100%';
          progressMessage.textContent = 'Video generation complete!';

          if (jobData.finalVideoUrl) {
            downloadContainer.style.display = 'block';
          }
        } else if (jobData.status === 'Failed - Retry Recommended') {
          // Special handling for bot detection/rate limiting
          retryContainer.style.display = 'block';
          retryMessage.textContent = jobData.error || 'YouTube is restricting video content scraping right now.';
          
          if (jobData.suggestions) {
            suggestionsText.textContent = jobData.suggestions;
          } else {
            suggestionsText.textContent = 'Try selecting fewer videos from your search results to avoid detection.';
          }
        } else if (jobData.status && jobData.status.startsWith('Failed')) {
          // Handle other failure types
          errorContainer.style.display = 'block';
          
          if (jobData.status === 'Failed - Video Unavailable') {
            errorMessage.textContent = `üìπ ${jobData.error || 'The video is no longer available on YouTube.'}`;
          } else if (jobData.status === 'Failed - Age Restricted') {
            errorMessage.textContent = `üîû ${jobData.error || 'The video has age restrictions that prevent processing.'}`;
          } else if (jobData.status === 'Failed - Technical Issue') {
            errorMessage.textContent = `‚öôÔ∏è ${jobData.error || 'A technical issue occurred during processing.'}`;
          } else {
            errorMessage.textContent = jobData.error || 'An unknown error occurred.';
          }
        }
      }

      // Make functions globally accessible
      window.downloadVideo = function () {
        if (currentJobData && currentJobData.finalVideoUrl) {
          window.open(currentJobData.finalVideoUrl, '_blank');
        } else {
          alert('Video URL not available yet.');
        }
      };

      window.goBackToSelection = function () {
        // Store the current search query if available
        const searchQuery = localStorage.getItem('lastSearchQuery') || '';
        
        // Redirect back to index with a flag to show video selection
        window.location.href = `index.html?showSelection=true&query=${encodeURIComponent(searchQuery)}`;
      };

      window.retryCurrentJob = function () {
        if (!currentJobData) {
          alert('No job data available for retry.');
          return;
        }

        const confirmRetry = confirm(
          'This will retry the same video selection after a delay. ' +
          'YouTube might still block the request. Are you sure you want to continue?'
        );

        if (confirmRetry) {
          // Add a delay before retry to respect rate limiting
          setTimeout(() => {
            alert('Retry functionality would be implemented here. For now, please go back and select fewer videos.');
            goBackToSelection();
          }, 2000);
        }
      };
    });
  </script>
</body>

</html>